<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>volatile关键字 | Auraro&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/logo.png">
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?xxxxxxxxxxxxxxxx"; 
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();</script>
    <script language="javascript" type="text/javascript" src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="/js/MouseClickEffect.js"></script>
    <meta name="description" content="面向对象面向君，不负代码不负卿。">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="keywords" content="AuraroJ,博客,conimi,nico">
    
    <link rel="preload" href="/assets/css/0.styles.027e4287.css" as="style"><link rel="preload" href="/assets/js/app.e031ceff.js" as="script"><link rel="preload" href="/assets/js/3.9f1a6eaf.js" as="script"><link rel="preload" href="/assets/js/1.d84df3c3.js" as="script"><link rel="preload" href="/assets/js/52.4759e45e.js" as="script"><link rel="prefetch" href="/assets/js/10.494379e0.js"><link rel="prefetch" href="/assets/js/100.d36aa66b.js"><link rel="prefetch" href="/assets/js/101.79aab1cf.js"><link rel="prefetch" href="/assets/js/102.c73d4fc8.js"><link rel="prefetch" href="/assets/js/103.ae520bb5.js"><link rel="prefetch" href="/assets/js/104.9f5cc462.js"><link rel="prefetch" href="/assets/js/105.f9940071.js"><link rel="prefetch" href="/assets/js/106.f0822b5e.js"><link rel="prefetch" href="/assets/js/107.a63026c0.js"><link rel="prefetch" href="/assets/js/108.14370b5b.js"><link rel="prefetch" href="/assets/js/109.52bd02dc.js"><link rel="prefetch" href="/assets/js/11.a41d38e0.js"><link rel="prefetch" href="/assets/js/110.fee01165.js"><link rel="prefetch" href="/assets/js/111.effbf9bd.js"><link rel="prefetch" href="/assets/js/112.988a522d.js"><link rel="prefetch" href="/assets/js/113.2a1694a9.js"><link rel="prefetch" href="/assets/js/114.53aaaa99.js"><link rel="prefetch" href="/assets/js/115.995b49a3.js"><link rel="prefetch" href="/assets/js/116.5884050b.js"><link rel="prefetch" href="/assets/js/117.dfa4ee4b.js"><link rel="prefetch" href="/assets/js/118.df187984.js"><link rel="prefetch" href="/assets/js/119.05610b67.js"><link rel="prefetch" href="/assets/js/12.98ef3cb5.js"><link rel="prefetch" href="/assets/js/120.bbe11417.js"><link rel="prefetch" href="/assets/js/121.007aa1f6.js"><link rel="prefetch" href="/assets/js/122.56071cdd.js"><link rel="prefetch" href="/assets/js/123.dead66b8.js"><link rel="prefetch" href="/assets/js/124.5ed1780c.js"><link rel="prefetch" href="/assets/js/125.efd59e72.js"><link rel="prefetch" href="/assets/js/126.185c7c0f.js"><link rel="prefetch" href="/assets/js/127.2c8f4705.js"><link rel="prefetch" href="/assets/js/128.8a1ab4ad.js"><link rel="prefetch" href="/assets/js/129.78975c56.js"><link rel="prefetch" href="/assets/js/13.3097e856.js"><link rel="prefetch" href="/assets/js/130.a0f621dc.js"><link rel="prefetch" href="/assets/js/131.03968694.js"><link rel="prefetch" href="/assets/js/132.44fcd83f.js"><link rel="prefetch" href="/assets/js/133.c701b57b.js"><link rel="prefetch" href="/assets/js/134.15037dc8.js"><link rel="prefetch" href="/assets/js/135.7566f9ae.js"><link rel="prefetch" href="/assets/js/136.014aab48.js"><link rel="prefetch" href="/assets/js/137.f4683b99.js"><link rel="prefetch" href="/assets/js/138.b8825bc9.js"><link rel="prefetch" href="/assets/js/139.e8f8230f.js"><link rel="prefetch" href="/assets/js/14.f890b3d6.js"><link rel="prefetch" href="/assets/js/140.d549430e.js"><link rel="prefetch" href="/assets/js/141.f84df317.js"><link rel="prefetch" href="/assets/js/142.ef9bd4a5.js"><link rel="prefetch" href="/assets/js/143.9e4c2be6.js"><link rel="prefetch" href="/assets/js/144.00188f86.js"><link rel="prefetch" href="/assets/js/145.d86e0a92.js"><link rel="prefetch" href="/assets/js/146.f24c3627.js"><link rel="prefetch" href="/assets/js/147.134a9321.js"><link rel="prefetch" href="/assets/js/148.fc24c3e8.js"><link rel="prefetch" href="/assets/js/149.84afd255.js"><link rel="prefetch" href="/assets/js/15.72b0b93f.js"><link rel="prefetch" href="/assets/js/150.e2ead216.js"><link rel="prefetch" href="/assets/js/151.71a4425f.js"><link rel="prefetch" href="/assets/js/152.f30db647.js"><link rel="prefetch" href="/assets/js/153.7ee40dc2.js"><link rel="prefetch" href="/assets/js/154.b8cbfdf7.js"><link rel="prefetch" href="/assets/js/155.a100f1d6.js"><link rel="prefetch" href="/assets/js/156.8dc5bb0d.js"><link rel="prefetch" href="/assets/js/157.4131af04.js"><link rel="prefetch" href="/assets/js/158.d36e28f3.js"><link rel="prefetch" href="/assets/js/159.858fa7e5.js"><link rel="prefetch" href="/assets/js/16.7f0869b9.js"><link rel="prefetch" href="/assets/js/160.59b5390c.js"><link rel="prefetch" href="/assets/js/161.779e20ed.js"><link rel="prefetch" href="/assets/js/162.84f087e3.js"><link rel="prefetch" href="/assets/js/17.98f028c6.js"><link rel="prefetch" href="/assets/js/18.d88b2af7.js"><link rel="prefetch" href="/assets/js/19.c61b9bbc.js"><link rel="prefetch" href="/assets/js/20.b5da2cd4.js"><link rel="prefetch" href="/assets/js/21.dfb435ca.js"><link rel="prefetch" href="/assets/js/22.31edf54d.js"><link rel="prefetch" href="/assets/js/23.405a3d83.js"><link rel="prefetch" href="/assets/js/24.18888b8f.js"><link rel="prefetch" href="/assets/js/25.651173b1.js"><link rel="prefetch" href="/assets/js/26.fa54a7cc.js"><link rel="prefetch" href="/assets/js/27.727f43f7.js"><link rel="prefetch" href="/assets/js/28.ee43730c.js"><link rel="prefetch" href="/assets/js/29.7a54cc39.js"><link rel="prefetch" href="/assets/js/30.b5485c20.js"><link rel="prefetch" href="/assets/js/31.a7bafc07.js"><link rel="prefetch" href="/assets/js/32.a02b3b33.js"><link rel="prefetch" href="/assets/js/33.f72b9114.js"><link rel="prefetch" href="/assets/js/34.e2bbf800.js"><link rel="prefetch" href="/assets/js/35.16511916.js"><link rel="prefetch" href="/assets/js/36.ac6774ae.js"><link rel="prefetch" href="/assets/js/37.07431bc6.js"><link rel="prefetch" href="/assets/js/38.fc412347.js"><link rel="prefetch" href="/assets/js/39.28ac8033.js"><link rel="prefetch" href="/assets/js/4.c56021c5.js"><link rel="prefetch" href="/assets/js/40.c5242f11.js"><link rel="prefetch" href="/assets/js/41.9f04ec65.js"><link rel="prefetch" href="/assets/js/42.83d9abc0.js"><link rel="prefetch" href="/assets/js/43.7acedec1.js"><link rel="prefetch" href="/assets/js/44.d02d2cf5.js"><link rel="prefetch" href="/assets/js/45.b288cb51.js"><link rel="prefetch" href="/assets/js/46.b45ee203.js"><link rel="prefetch" href="/assets/js/47.f912b935.js"><link rel="prefetch" href="/assets/js/48.cb455cea.js"><link rel="prefetch" href="/assets/js/49.e010c420.js"><link rel="prefetch" href="/assets/js/5.346d06ac.js"><link rel="prefetch" href="/assets/js/50.6ca2d93a.js"><link rel="prefetch" href="/assets/js/51.896be954.js"><link rel="prefetch" href="/assets/js/53.d33daccb.js"><link rel="prefetch" href="/assets/js/54.20094aa7.js"><link rel="prefetch" href="/assets/js/55.53d55ff4.js"><link rel="prefetch" href="/assets/js/56.b410002a.js"><link rel="prefetch" href="/assets/js/57.b10590e9.js"><link rel="prefetch" href="/assets/js/58.e016b0e8.js"><link rel="prefetch" href="/assets/js/59.05d20761.js"><link rel="prefetch" href="/assets/js/6.15697138.js"><link rel="prefetch" href="/assets/js/60.fc30e643.js"><link rel="prefetch" href="/assets/js/61.5cf84135.js"><link rel="prefetch" href="/assets/js/62.ff8cbdb7.js"><link rel="prefetch" href="/assets/js/63.47189271.js"><link rel="prefetch" href="/assets/js/64.c0bc35e5.js"><link rel="prefetch" href="/assets/js/65.198d8e76.js"><link rel="prefetch" href="/assets/js/66.8c56da5d.js"><link rel="prefetch" href="/assets/js/67.cd6e5560.js"><link rel="prefetch" href="/assets/js/68.7780e444.js"><link rel="prefetch" href="/assets/js/69.5fe691a7.js"><link rel="prefetch" href="/assets/js/7.faeb4c9c.js"><link rel="prefetch" href="/assets/js/70.8e8994a9.js"><link rel="prefetch" href="/assets/js/71.25d77bf7.js"><link rel="prefetch" href="/assets/js/72.bcd79ebe.js"><link rel="prefetch" href="/assets/js/73.a105ea72.js"><link rel="prefetch" href="/assets/js/74.1bd7297d.js"><link rel="prefetch" href="/assets/js/75.f048f4e1.js"><link rel="prefetch" href="/assets/js/76.9f829f89.js"><link rel="prefetch" href="/assets/js/77.623bf9f5.js"><link rel="prefetch" href="/assets/js/78.6ad4f27d.js"><link rel="prefetch" href="/assets/js/79.a86927ea.js"><link rel="prefetch" href="/assets/js/8.b8fbacea.js"><link rel="prefetch" href="/assets/js/80.d65132d3.js"><link rel="prefetch" href="/assets/js/81.5272b7cb.js"><link rel="prefetch" href="/assets/js/82.c9c4faa3.js"><link rel="prefetch" href="/assets/js/83.4797e95f.js"><link rel="prefetch" href="/assets/js/84.43aead33.js"><link rel="prefetch" href="/assets/js/85.523acf40.js"><link rel="prefetch" href="/assets/js/86.e3a90b39.js"><link rel="prefetch" href="/assets/js/87.db03f315.js"><link rel="prefetch" href="/assets/js/88.011203bc.js"><link rel="prefetch" href="/assets/js/89.ccecd215.js"><link rel="prefetch" href="/assets/js/9.3f76ee1e.js"><link rel="prefetch" href="/assets/js/90.b3673b12.js"><link rel="prefetch" href="/assets/js/91.944d53bf.js"><link rel="prefetch" href="/assets/js/92.7056fdf7.js"><link rel="prefetch" href="/assets/js/93.a937eb7f.js"><link rel="prefetch" href="/assets/js/94.512fcb2c.js"><link rel="prefetch" href="/assets/js/95.229f7c1c.js"><link rel="prefetch" href="/assets/js/96.11909071.js"><link rel="prefetch" href="/assets/js/97.cee3de64.js"><link rel="prefetch" href="/assets/js/98.2944ddbc.js"><link rel="prefetch" href="/assets/js/99.eed405c9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.027e4287.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-ce6b9c28><div data-v-ce6b9c28><div class="password-shadow password-wrapper-out" style="display:none;" data-v-f68096de data-v-ce6b9c28 data-v-ce6b9c28><h3 class="title" data-v-f68096de>Auraro's Blog</h3> <p class="description" data-v-f68096de>面向对象面向君，不负代码不负卿。</p> <label id="box" class="inputBox" data-v-f68096de><input type="password" value="" data-v-f68096de> <span data-v-f68096de>Konck! Knock!</span> <button data-v-f68096de>OK</button></label> <div class="footer" data-v-f68096de><span data-v-f68096de><i class="iconfont reco-theme" data-v-f68096de></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-f68096de>vuePress-theme-reco</a></span> <span data-v-f68096de><i class="iconfont reco-copyright" data-v-f68096de></i> <a data-v-f68096de><span data-v-f68096de>AuraroJ</span>
          
        <!---->
        2022
      </a></span></div></div> <div class="hide" data-v-ce6b9c28><header class="navbar" data-v-ce6b9c28><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Auraro's Blog" class="logo"> <span class="site-name">Auraro's Blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  随性一点的主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/随笔/me.html" class="nav-link"><i class="undefined"></i>
  随笔
</a></li><li class="dropdown-item"><!----> <a href="/docs/network/浏览器输入url过程.html" class="nav-link"><i class="undefined"></i>
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/docs/Os/段式存储和页式存储.html" class="nav-link"><i class="undefined"></i>
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/docs/中间件/数据库/事务.html" class="nav-link"><i class="undefined"></i>
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/docs/Java/JavaDesignModel/单例模式.html" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/docs/SpringCloud/微服务架构介绍.html" class="nav-link"><i class="undefined"></i>
  Java框架
</a></li><li class="dropdown-item"><!----> <a href="/docs/Linux/常见面试题.html" class="nav-link"><i class="undefined"></i>
  Linux
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  归档
</a></div><div class="nav-item"><a href="/review.html" class="nav-link"><i class="iconfont reco-blog"></i>
  回顾
</a></div><div class="nav-item"><a href="/about.html" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-ce6b9c28></div> <aside class="sidebar" data-v-ce6b9c28><div class="personal-info-wrapper" data-v-cc06b9e8 data-v-ce6b9c28><img src="/logo.png" alt="author-avatar" class="personal-img" data-v-cc06b9e8> <h3 class="name" data-v-cc06b9e8>
    AuraroJ
  </h3> <div class="num" data-v-cc06b9e8><div data-v-cc06b9e8><h3 data-v-cc06b9e8>151</h3> <h6 data-v-cc06b9e8>文章</h6></div> <div data-v-cc06b9e8><h3 data-v-cc06b9e8>61</h3> <h6 data-v-cc06b9e8>标签</h6></div></div> <ul class="social-links" data-v-cc06b9e8></ul> <hr data-v-cc06b9e8></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  随性一点的主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/随笔/me.html" class="nav-link"><i class="undefined"></i>
  随笔
</a></li><li class="dropdown-item"><!----> <a href="/docs/network/浏览器输入url过程.html" class="nav-link"><i class="undefined"></i>
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/docs/Os/段式存储和页式存储.html" class="nav-link"><i class="undefined"></i>
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/docs/中间件/数据库/事务.html" class="nav-link"><i class="undefined"></i>
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/docs/Java/JavaDesignModel/单例模式.html" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/docs/SpringCloud/微服务架构介绍.html" class="nav-link"><i class="undefined"></i>
  Java框架
</a></li><li class="dropdown-item"><!----> <a href="/docs/Linux/常见面试题.html" class="nav-link"><i class="undefined"></i>
  Linux
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  归档
</a></div><div class="nav-item"><a href="/review.html" class="nav-link"><i class="iconfont reco-blog"></i>
  回顾
</a></div><div class="nav-item"><a href="/about.html" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>锁</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>线程池</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>其他</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/Java/JUC/BIO、NIO、AIO的区别.html" class="sidebar-link">BIO、NIO、AIO区别</a></li><li><a href="/docs/Java/JUC/volatile关键字.html" class="active sidebar-link">volatile关键字</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-f68096de data-v-ce6b9c28><h3 class="title" data-v-f68096de>volatile关键字</h3> <!----> <label id="box" class="inputBox" data-v-f68096de><input type="password" value="" data-v-f68096de> <span data-v-f68096de>Konck! Knock!</span> <button data-v-f68096de>OK</button></label> <div class="footer" data-v-f68096de><span data-v-f68096de><i class="iconfont reco-theme" data-v-f68096de></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-f68096de>vuePress-theme-reco</a></span> <span data-v-f68096de><i class="iconfont reco-copyright" data-v-f68096de></i> <a data-v-f68096de><span data-v-f68096de>AuraroJ</span>
          
        <!---->
        2022
      </a></span></div></div> <div data-v-ce6b9c28><div data-v-ce6b9c28><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">volatile关键字</h1> <div data-v-1e62957f><i class="iconfont reco-account" data-v-1e62957f><span data-v-1e62957f>AuraroJ</span></i> <i class="iconfont reco-date" data-v-1e62957f><span data-v-1e62957f>2022/3/5</span></i> <i class="iconfont reco-eye" data-v-1e62957f><span id="/docs/Java/JUC/volatile%E5%85%B3%E9%94%AE%E5%AD%97.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-1e62957f><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-1e62957f><span class="tag-item" data-v-1e62957f>内存模型</span><span class="tag-item" data-v-1e62957f>JUC</span></i></div></div> <div class="theme-reco-content content__default"><h3 id="一、内存模型的相关概念"><a href="#一、内存模型的相关概念" class="header-anchor">#</a> 一、内存模型的相关概念</h3> <p>大家都知道，计算机在执行程序时，每条指令都是在CPU中执行的，而执行指令过程中，势必涉及到数据的读取和写入。由于程序运行过程中的临时数据是存放在主存（物理内存）当中的，这时就存在一个问题，由于CPU执行速度很快，而从内存读取数据和向内存写入数据的过程跟CPU执行指令的速度比起来要慢的多，因此如果任何时候对数据的操作都要通过和内存的交互来进行，会大大降低指令执行的速度。因此在CPU里面就有了高速缓存。</p> <p>也就是，当程序在运行过程中，会将运算需要的数据从主存复制一份到CPU的高速缓存当中，那么CPU进行计算时就可以直接从它的高速缓存读取数据和向其中写入数据，当运算结束之后，再将高速缓存中的数据刷新到主存当中。举个简单的例子，比如下面的这段代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>当线程执行这个语句时，会先从主存当中读取i的值，然后复制一份到高速缓存当中，然后CPU执行指令对i进行加1操作，然后将数据写入高速缓存，最后将高速缓存中i最新的值刷新到主存当中</p> <p><code>这个代码在单线程中运行是没有任何问题的，但是在多线程中运行就会有问题了。在多核CPU中，每条线程可能运行于不同的CPU中，因此每个线程运行时有自己的高速缓存</code>（对单核CPU来说，其实也会出现这种问题，只不过是以线程调度的形式来分别执行的）。本文我们以多核CPU为例。</p> <p>比如同时有2个线程执行这段代码，假如初始时i的值为0，那么我们希望两个线程执行完之后i的值变为2。但是事实会是这样吗？</p> <p><code>可能存在下面一种情况：初始时，两个线程分别读取i的值存入各自所在的CPU的高速缓存当中，然后线程1进行加1操作，然后把i的最新值1写入到内存。此时线程2的高速缓存当中i的值还是0，进行加1操作之后，i的值为1，然后线程2把i的值写入内存。</code></p> <p><code>最终结果i的值是1，而不是2。这就是著名的缓存一致性问题。通常称这种被多个线程访问的变量为共享变量。</code></p> <p>也就是说，如果一个变量在多个CPU中都存在缓存（一般在多线程编程时才会出现），那么就可能存在缓存不一致的问题。</p> <p>为了解决缓存不一致性问题，通常来说有以下2种解决方法：</p> <p>1）通过在总线加LOCK#锁的方式</p> <p>2）通过缓存一致性协议</p> <p>这2种方式都是硬件层面上提供的方式。</p> <p>在早期的CPU当中，是通过在总线上加LOCK#锁的形式来解决缓存不一致的问题。因为CPU和其他部件进行通信都是通过总线来进行的，如果对总线加LOCK#锁的话，也就是说阻塞了其他CPU对其他部件访问（如内存），从而使得只能有一个CPU能使用这个变量的内存。比如上面例子中 如果一个线程在执行 i = i +1，如果在执行这段代码的过程中，在总线上发出了LCOK#锁的信号，那么只有等待这段代码完全执行完毕之后，其他CPU才能从变量i所在的内存读取变量，然后进行相应的操作。这样就解决了缓存不一致的问题。</p> <p>但是上面的方式会有一个问题，由于在锁住总线期间，其他CPU无法访问内存，导致效率低下。</p> <p>所以就出现了缓存一致性协议。最出名的就是Intel 的<code>MESI</code>协议，MESI协议保证了每个缓存中使用的共享变量的副本是一致的.</p> <p><strong>它核心的思想是：当CPU写数据时，如果发现操作的变量是共享变量，即在其他CPU中也存在该变量的副本，会发出信号通知其他CPU将该变量的缓存行置为无效状态，因此当其他CPU需要读取这个变量时，发现自己缓存中缓存该变量的缓存行是无效的，那么它就会从内存重新读取。</strong></p> <p><img src="https://img-blog.csdnimg.cn/efd5481c405647889cb4b8d2326c33df.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAbGVlZGNvZGVKb2huMDE=,size_18,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p> <h3 id="二、并发编程中的三个概念"><a href="#二、并发编程中的三个概念" class="header-anchor">#</a> 二、并发编程中的三个概念</h3> <h4 id="_1、原子性"><a href="#_1、原子性" class="header-anchor">#</a> 1、原子性</h4> <p><code>即一个操作或者多个操作，要么全部执行并且执行过程不会被任何因素打断，要么就都不执行。</code></p> <p>一个很经典的例子就是银行账户转账问题：</p> <p>比如从账户A向账户B转1000元，那么必然包括2个操作：从账户A减去1000元，往账户B加上1000元。</p> <p>试想一下，如果这2个操作不具备原子性，会造成什么样的后果。假如从账户A减去1000元之后，操作突然中止。然后又从B取出了500元，取出500元之后，再执行 往账户B加上1000元 的操作。这样就会导致账户A虽然减去了1000元，但是账户B没有收到这个转过来的1000元。</p> <p>所以这2个操作必须要具备原子性才能保证不出现一些意外的问题。</p> <p>同样地反映到并发编程中会出现什么结果呢？</p> <h4 id="_2、可见性"><a href="#_2、可见性" class="header-anchor">#</a> 2、可见性</h4> <p>可见性是指多个线程访问同一个变量时，一个线程修改了这个变量的值，其他线程能够立即看到修改的值。</p> <p>举个简单的例子，看下面这段代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//线程1执行的代码</span>
<span class="token keyword">int</span>  <span class="token class-name">I</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token class-name">I</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token comment">//线程2执行的代码</span>
j <span class="token operator">=</span> <span class="token class-name">I</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>假若执行线程1的是CPU1，执行线程2的是CPU2。由上面的分析可知，当线程1执行I = 10这句时，会先把i的初始值加载到CPU1的高速缓存中，然后赋值为10，那么在CPU1的高速缓存当中的i的值就变为10了，却没有立刻写入主存。</p> <p>此时线程2执行j = I，他会先去主存读取值并加载到CPU2的缓存中，注意此时内存中的i值还是0，那么就会使得j的值变为0，而不是10。</p> <p><code>这就是可见性问题，线程1对i变量值的修改，线程2没有立刻看见线程1的修改。</code></p> <h4 id="_3、有序性"><a href="#_3、有序性" class="header-anchor">#</a> 3、有序性</h4> <p><code>有序性：即程序执行的顺序按照代码的先后顺序执行</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span> <span class="token class-name">I</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token class-name">I</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">//语句1</span>
flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token comment">//语句2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>上面的代码定义了一个int型变量，定义了一个Boolean型变量，然后分别对这两个变量进行赋值操作。<code>从代码顺序上看，语句1在语句2的前面，那么JVM在真正执行这段代码的时候不一定会保证语句1在语句2之前执行，这里可能会发生指令重排序（Instruction Recorder）</code></p> <p>一般来说，处理器为了提高程序的运行效率，可能会对输入代码进行优化，他不保证程序中各个语句的执行顺讯同代码中的顺序一致，但是它会保证最终执行的结果和代码顺序的执行结果是一致的。</p> <p>语句1和语句2谁先执行对最终的程序结果并没有影响，那么就有可能在执行过程中，语句2先执行而后语句1后执行。</p> <p>虽然处理器会对指令进行重排序，但是他会保证程序最终结果会和顺序执行代码的结果相同，如何保证？</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">//语句1</span>
<span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">//语句2</span>
a <span class="token operator">=</span> a<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">;</span>  <span class="token comment">//语句3</span>
r <span class="token operator">=</span> a <span class="token operator">*</span> a<span class="token punctuation">;</span> <span class="token comment">//语句4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这段代码的执行顺序可能如下：</p> <p><img src="https://img-blog.csdnimg.cn/f4a2a370afc24b4396839423185d5070.png" alt="在这里插入图片描述"></p> <p>但是语句的执行顺序不会为：语句2 -&gt; 语句1 -&gt;语句4 -&gt; 语句3
因为这样的执行顺序得到的结果与预期的代码顺序下得到的结果显然不同。</p> <p>虽然重排序不会影响单个线程内程序执行的结果，但是多线程呢？</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//线程1:</span>
context <span class="token operator">=</span> <span class="token function">loadContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//语句1</span>
inited <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>             <span class="token comment">//语句2</span>
 
<span class="token comment">//线程2:</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>inited <span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
<span class="token function">doSomethingwithconfig</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>上面代码中，由于语句1和语句2没有数据依赖性，因此会被重排序。假如发生重排序，在线程1执行过程中先执行语句2，而此时线程2会以为初始化工作已经完成，那么就会跳出while循环，去执行doSomethingWithconfig(context)方法，而此时context并没有被初始化，会导致程序错误。</p> <p><code>从上面可以看出，指令重排序不会影响单个线程的执行，但是会影响到线程并发执行的正确性。</code></p> <p><code>也就是说，要想并发程序正确地执行，必须要保证原子性、可见性以及有序性。只要有一个没有被保证，就有可能会导致程序运行不正确。</code></p> <h3 id="三、java内存模型"><a href="#三、java内存模型" class="header-anchor">#</a> 三、Java内存模型</h3> <p>在前面谈到了一些关于内存模型以及并发编程中可能会出现的一些问题。下面我们来看一下Java内存模型，研究一下Java内存模型为我们提供了哪些保证以及在java中提供了哪些方法和机制来让我们在进行多线程编程时能够保证程序执行的正确性。</p> <p>在Java虚拟机规范中试图定义一种Java内存模型（Java Memory Model，JMM）来屏蔽各个硬件平台和操作系统的内存访问差异，以实现让Java程序在各种平台下都能达到一致的内存访问效果。那么Java内存模型规定了哪些东西呢，它定义了程序中变量的访问规则，往大一点说是定义了程序执行的次序。注意，为了获得较好的执行性能，Java内存模型并没有限制执行引擎使用处理器的寄存器或者高速缓存来提升指令执行速度，也没有限制编译器对指令进行重排序。也就是说，在java内存模型中，也会存在缓存一致性问题和指令重排序的问题。</p> <p><strong>Java内存模型规定所有的变量都是存在主存当中（类似于前面说的物理内存），每个线程都有自己的工作内存（类似于前面的高速缓存）。线程对变量的所有操作都必须在工作内存中进行，而不能直接对主存进行操作。并且每个线程不能访问其他线程的工作内存。</strong></p> <p>举个简单的例子：在java中，执行下面这个语句：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">I</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>执行线程必须先在自己的工作线程中对变量i所在的缓存进行赋值操作，然后再写入主存中。而不是直接将数值10写入主存当中。</p> <h4 id="_1、原子性-2"><a href="#_1、原子性-2" class="header-anchor">#</a> 1、原子性</h4> <p>在java中，对基本数据类型的变量的读取和赋值操作是原子性操作，即这些操作是不可被中断的，要么执行，要么不执行；</p> <p>分析下列操作哪些是原子性操作？</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>  <span class="token comment">//语句1</span>
y <span class="token operator">=</span> x<span class="token punctuation">;</span>     <span class="token comment">//语句2</span>
x<span class="token operator">++</span><span class="token punctuation">;</span>      <span class="token comment">//语句3</span>
x <span class="token operator">=</span> x <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">//语句4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>上述语句只有语句1是原子操作：</p> <p>语句1是直接将数值赋给x，也就是说线程执行这个语句会直接将数值10写到工作内存中。</p> <p>语句2实际上包含2个操作，它先要读取x的值，再将x的值写入工作内存，虽然读取x的值以及将x的值写入工作内存，这两个操作都是原子性的，但是合起来就不是原子性操作了。</p> <p>同样的，x++和x = x +1包括3个操作：读取x的值，进行加1操作，写入新的值。</p> <p>也就是说只有简单的读取、赋值是原子操作（而且必须是将字面值赋值个某个变量，如果是变量间的相互赋值，也不是原子操作）。</p> <p>由上：Java内存模型只保存了基本读取和赋值是原子性操作，如果要实现更大范围操作的原子性，可以通过synchronized和lock来实现。由于synchronized和lock能够保证任一时刻只有一个线程执行该代码块，那么自然就不存在原子性问题了，从而保证了原子性。</p> <h4 id="_2、可见性-2"><a href="#_2、可见性-2" class="header-anchor">#</a> 2、可见性</h4> <p>对于可见性，Java提供了volatile关键字来保证可见性。
当一个共享变量被volatile修饰时，他会保证修改的值立即被更新到主存，当有其他线程需要读取时，他会去内存中读取新值。</p> <p>而普通的共享变量不能保证可见性，因为普通共享变量被修改之后，什么时候被写入主存是不确定的，当其他线程去读取时，此时内存中可能还是原来的旧值，因为无法保证可见性。</p> <p>另外，通过synchronized和lock也可以保证可见性，synchronized和lock能保证同一时刻只有一个线程获取锁然后执行同步代码块，并且在释放锁之前会将对变量的修改刷新到主存当中。因此可以保证可见性。</p> <h4 id="_3、有序性-2"><a href="#_3、有序性-2" class="header-anchor">#</a> 3、有序性</h4> <p>在Java内存模型中，允许编译器和处理器对指令进行重排序，但是重排序过程不会影响到单线程的执行结果，却会影响到多线程的执行结果。</p> <p>在java里面，可以通过volatile关键字来保证一定的“有序性”。另外可以通过synchronized和lock来保证有序性，很显然，synchronized和lock保证每个时刻是有一个线程执行同步代码，相当于是让线程顺序执行同步代码，自然保证了有序性。</p> <p>另外,<code>java内存模型具备一些先天的“有序性”，即不需要通过任何手段就能够得到保证的有序性，这个通常也称为happens-before原则，如果两个操作的执行顺序无法从happens-before原则中推导出来，那么他们就不能保证有序性，虚拟机可以随意的对他们进行重排序。</code></p> <p>下面就来具体介绍下happens-before原则（先行发生原则）：</p> <p>程序次序规则：一个线程内，按照代码顺序，书写在前面的操作先行发生于书写在后面的操作</p> <p>锁定规则：一个unLock操作先行发生于后面对同一个锁的lock操作</p> <p>volatile变量规则：对一个变量的写操作先行发生于后面对这个变量的读操作</p> <p>传递规则：如果操作A先行发生于操作B，而操作B又先行发生于操作C，则可以得出操作A先行发生于操作C</p> <p>线程启动规则：Thread对象的start()方法先行发生于此线程的每个一个动作</p> <p>线程中断规则：对线程interrupt()方法的调用先行发生于被中断线程的代码检测到中断事件的发生</p> <p>线程终结规则：线程中所有的操作都先行发生于线程的终止检测，我们可以通过Thread.join()方法结束、Thread.isAlive()的返回值手段检测到线程已经终止执行</p> <p>对象终结规则：一个对象的初始化完成先行发生于他的finalize()方法的开始</p> <p>对于程序次序规则来说，我的理解就是一段程序代码的执行在单个线程中看起来是有序的。注意，虽然这条规则中提到“书写在前面的操作先行发生于书写在后面的操作”，这个应该是程序看起来执行的顺序是按照代码顺序执行的，因为虚拟机可能会对程序代码进行指令重排序。虽然进行重排序，但是最终执行的结果是与程序顺序执行的结果一致的，<code>它只会对不存在数据依赖性的指令进行重排序</code>。因此，在单个线程中，程序执行看起来是有序执行的，这一点要注意理解。事实上，这个规则是用来保证程序在单线程中执行结果的正确性，但无法保证程序在多线程中执行的正确性。</p> <p>第二条规则也比较容易理解，也就是说无论在单线程中还是多线程中，同一个锁如果处于被锁定的状态，那么必须先对锁进行了释放操作，后面才能继续进行lock操作。</p> <p>第三条规则是一条比较重要的规则，也是后文将要重点讲述的内容。直观地解释就是，如果一个线程先去写一个变量，然后一个线程去进行读取，那么写入操作肯定会先行发生于读操作。</p> <p>第四条规则实际上就是体现happens-before原则具备传递性。</p> <h3 id="四、深入剖析volatile关键字"><a href="#四、深入剖析volatile关键字" class="header-anchor">#</a> 四、深入剖析volatile关键字</h3> <h4 id="_1、volatile关键字的两层语义"><a href="#_1、volatile关键字的两层语义" class="header-anchor">#</a> 1、volatile关键字的两层语义</h4> <p>一旦一个共享变量（类的成员变量、类的静态成员变量）被volatile修饰之后，那么就具备了两层语义；</p> <p>1）保证了不同线程对这个变量进行操作时的可见性，即一个线程修改了某个变量的值，这新值对其他线程来说是立即可见的；</p> <p>2）禁止进行指令重排序；</p> <p>先看一段代码，假如线程1先执行，线程2后执行：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//线程1</span>
<span class="token keyword">boolean</span> stop <span class="token operator">=</span> <span class="token boolean">false</span>；
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>stop<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//线程2</span>
stop <span class="token operator">=</span> <span class="token boolean">true</span>；
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>下面解释一下这段代码为何有可能导致无法中断线程。在前面已经解释过，每个线程在运行过程中都有自己的工作内存，那么线程1在运行的时候，会将stop变量的值拷贝一份放在自己的工作内存当中。</p> <p>那么当线程2更改了stop变量的值之后，但是还没来得及写入主存当中，线程2转去做其他事情了，那么线程1由于不知道线程2对stop变量的更改，因此还会一直循环下去。</p> <p>但是用volatile修饰之后就变得不一样了：</p> <p>第一：使用volatile关键字会强制将修改的值立即写入主存；</p> <p>第二：使用volatile关键字的话，当线程2进行修改时，会导致线程1的工作内存中缓存变量stop的缓存行无效（反映到硬件层的话，就是CPU的L1或者L2缓存中对应的缓存行无效）；</p> <p>第三：由于线程1的工作内存中缓存变量stop的缓存行无效，所以线程1再次读取变量stop的值时会去主存读取。</p> <p>那么在线程2修改stop值时（当然这里包括2个操作，修改线程2工作内存中的值，然后将修改后的值写入内存），会使得线程1的工作内存中缓存变量stop的缓存行无效，然后线程1读取时，发现自己的缓存行无效，它会等待缓存行对应的主存地址被更新之后，然后去对应的主存读取最新的值。</p> <p>那么线程1读取到的就是最新的正确的值。</p> <h4 id="_2、volatile保证原子性吗"><a href="#_2、volatile保证原子性吗" class="header-anchor">#</a> 2、volatile保证原子性吗？</h4> <p><img src="https://img-blog.csdnimg.cn/6778632463a148bdb4d4c00bbdc55489.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAbGVlZGNvZGVKb2huMDE=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p> <p>大家想一下这段程序的输出结果是多少？也许有些朋友认为是10000。但是事实上运行它会发现每次运行结果都不一致，都是一个小于10000的数字。</p> <p>可能有的朋友就会有疑问，不对啊，上面是对变量inc进行自增操作，由于volatile保证了可见性，那么在每个线程中对inc自增完之后，在其他线程中都能看到修改后的值啊，所以有10个线程分别进行了1000次操作，那么最终inc的值应该是1000*10=10000。</p> <p>这里面就有一个误区了，volatile关键字能保证可见性没有错，但是上面的程序错在没能保证原子性。可见性只能保证每次读取的是最新的值，但是volatile没办法保证对变量的操作的原子性。</p> <p>在前面已经提到过，自增操作是不具备原子性的，它包括读取变量的原始值、进行加1操作、写入工作内存。那么就是说自增操作的三个子操作可能会分割开执行，就有可能导致下面这种情况出现：</p> <p>假如某个时刻变量inc的值为10，</p> <p>线程1对变量进行自增操作，线程1先读取了变量inc的原始值，然后线程1被阻塞了；</p> <p>然后线程2对变量进行自增操作，线程2也去读取变量inc的原始值，由于线程1只是对变量inc进行读取操作，而没有对变量进行修改操作，所以不会导致线程2的工作内存中缓存变量inc的缓存行无效，所以线程2会直接去主存读取inc的值，发现inc的值时10，然后进行加1操作，并把11写入工作内存，最后写入主存。</p> <p>然后线程1接着进行加1操作，由于已经读取了inc的值，注意此时在线程1的工作内存中inc的值仍然为10，所以线程1对inc进行加1操作后inc的值为11，然后将11写入工作内存，最后写入主存。</p> <p>那么两个线程分别进行了一次自增操作后，inc只增加了1。</p> <p>解释到这里，可能有朋友会有疑问，不对啊，前面不是保证一个变量在修改volatile变量时，会让缓存行无效吗？然后其他线程去读就会读到新的值，对，这个没错。这个就是上面的happens-before规则中的volatile变量规则，但是要注意，线程1对变量进行读取操作之后，被阻塞了的话，并没有对inc值进行修改。然后虽然volatile能保证线程2对变量inc的值读取是从内存中读取的，但是线程1没有进行修改，所以线程2根本就不会看到修改的值。</p> <p><strong>根源就在这里，自增操作不是原子性操作，而且volatile也无法保证对变量的任何操作都是原子性的。</strong></p> <h4 id="_3、volatile能保证有序性吗"><a href="#_3、volatile能保证有序性吗" class="header-anchor">#</a> 3、volatile能保证有序性吗？</h4> <p>在前面提到volatile关键字能禁止指令重排序，所以volatile能在一定程度上保证有序性。</p> <p>volatile关键字禁止指令重排序有两层意思：</p> <p>1）当程序执行到volatile变量的读操作或者写操作时，在其前面的操作的更改肯定是全部已经进行，且结果已经对后面的操作可见，在其后面的操作肯定还没进行；</p> <p>2）在进行指令优化时，不能将在对volatile变量访问的语句放在其后面执行，也不能把volatile变量后的语句放在其前面执行。</p> <p>举个例子:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//x、y为非volatile变量</span>
<span class="token comment">//flag为volatile变量</span>
x <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">//语句1</span>
y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//语句2</span>
flag  <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>   <span class="token comment">//语句3</span>
x <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">//语句4</span>
y <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//语句5</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>由于flag变量为volatile变量，那么在进行指令重排序的过程的时候，不会将语句3放到语句1、语句2前面，也不会将语句3放到语句4、语句5后面。但是要注意语句1和语句2的顺序，语句4和语句5的顺序不做任何保证。</p> <p>并且volatile关键字能保证，执行到语句3时，语句1和语句2必定是执行完毕了的，且语句1和语句2的执行结果对语句3、4、5都是可见的。</p> <p>回到前面的一个例子：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//线程1:</span>
context <span class="token operator">=</span> <span class="token function">loadContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//语句1</span>
inited <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>             <span class="token comment">//语句2</span>
 
<span class="token comment">//线程2:</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>inited <span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
<span class="token function">doSomethingwithconfig</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>前面举这个例子的时候，提到有可能语句2会在语句1之前执行，那么就可能导致context还没被初始化，而线程2中就使用未初始化的context去进行操作，导致程序出错。</p> <p>这里如果用volatile关键字对inited变量进行修饰，就不会出现这种问题了，因为当执行到语句2时，必定能保证context已经初始化完毕。</p> <h4 id="_4、volatile的原理和实现机制"><a href="#_4、volatile的原理和实现机制" class="header-anchor">#</a> 4、volatile的原理和实现机制</h4> <p>观察加入volatile关键字和没有加入volatile关键字的汇编代码后发现，加入volatile关键字时，会多出一个lock前缀指令。</p> <p>lock前缀指令实际上相当于一个内存屏障（也称为内存栅栏），内存屏障会提供3个功能：</p> <p>1）它确保指令重排序时不会把其后面的指令排到内存屏障之前的位置，也不会把前面的指令排到内存屏障之后的位置，即在执行到内存屏障时，在他前面的操作都已经执行完毕了；</p> <p>2）他会强制将对缓存的修改操作立即写入主存；</p> <p>3）如果是写操作，它会导致其他CPU中对应的缓存行无效。</p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">Tue, 23 Aug 2022 17:13:44 GMT</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/docs/Java/JUC/BIO、NIO、AIO的区别.html" class="prev">
          BIO、NIO、AIO区别
        </a></span> <!----></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-130173e4><li class="level-3" data-v-130173e4><a href="/docs/Java/JUC/volatile%E5%85%B3%E9%94%AE%E5%AD%97.html#一、内存模型的相关概念" class="sidebar-link reco-side-一、内存模型的相关概念" data-v-130173e4>一、内存模型的相关概念</a></li><li class="level-3" data-v-130173e4><a href="/docs/Java/JUC/volatile%E5%85%B3%E9%94%AE%E5%AD%97.html#二、并发编程中的三个概念" class="sidebar-link reco-side-二、并发编程中的三个概念" data-v-130173e4>二、并发编程中的三个概念</a></li><li class="level-3" data-v-130173e4><a href="/docs/Java/JUC/volatile%E5%85%B3%E9%94%AE%E5%AD%97.html#三、java内存模型" class="sidebar-link reco-side-三、java内存模型" data-v-130173e4>三、Java内存模型</a></li><li class="level-3" data-v-130173e4><a href="/docs/Java/JUC/volatile%E5%85%B3%E9%94%AE%E5%AD%97.html#四、深入剖析volatile关键字" class="sidebar-link reco-side-四、深入剖析volatile关键字" data-v-130173e4>四、深入剖析volatile关键字</a></li></ul></main></div> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="Sakura" data-v-248d85d6><canvas id="canvas_sakura" style="z-index:-1;" data-v-248d85d6></canvas></div><canvas id="vuepress-canvas-cursor"></canvas></div></div>
    <script src="/assets/js/app.e031ceff.js" defer></script><script src="/assets/js/3.9f1a6eaf.js" defer></script><script src="/assets/js/1.d84df3c3.js" defer></script><script src="/assets/js/52.4759e45e.js" defer></script>
  </body>
</html>
