<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>操作系统lab8 locks | Auraro&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/logo.png">
    <script language="javascript" type="text/javascript" src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="/js/MouseClickEffect.js"></script>
    <meta name="description" content="面向对象面向君，不负代码不负卿。">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="keywords" content="AuraroJ,博客,conimi,nico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/assets/css/0.styles.f7a51907.css" as="style"><link rel="preload" href="/assets/js/app.bb08115f.js" as="script"><link rel="preload" href="/assets/js/3.583d0c72.js" as="script"><link rel="preload" href="/assets/js/1.eb42dbb0.js" as="script"><link rel="preload" href="/assets/js/282.60ce8d90.js" as="script"><link rel="prefetch" href="/assets/js/10.5cde4a25.js"><link rel="prefetch" href="/assets/js/100.75d8cc25.js"><link rel="prefetch" href="/assets/js/101.07aef68f.js"><link rel="prefetch" href="/assets/js/102.6be744c5.js"><link rel="prefetch" href="/assets/js/103.023b2c9f.js"><link rel="prefetch" href="/assets/js/104.cce0b172.js"><link rel="prefetch" href="/assets/js/105.c68ec71c.js"><link rel="prefetch" href="/assets/js/106.d8cd02e9.js"><link rel="prefetch" href="/assets/js/107.10ab63dc.js"><link rel="prefetch" href="/assets/js/108.c194d7a0.js"><link rel="prefetch" href="/assets/js/109.2ce7e1ec.js"><link rel="prefetch" href="/assets/js/11.00989c85.js"><link rel="prefetch" href="/assets/js/110.88e49ffa.js"><link rel="prefetch" href="/assets/js/111.83497f18.js"><link rel="prefetch" href="/assets/js/112.f0ab65da.js"><link rel="prefetch" href="/assets/js/113.1d693a7a.js"><link rel="prefetch" href="/assets/js/114.4c0138cc.js"><link rel="prefetch" href="/assets/js/115.a9b632ba.js"><link rel="prefetch" href="/assets/js/116.7b278849.js"><link rel="prefetch" href="/assets/js/117.d551d77f.js"><link rel="prefetch" href="/assets/js/118.446c75f9.js"><link rel="prefetch" href="/assets/js/119.159faacb.js"><link rel="prefetch" href="/assets/js/12.089cc736.js"><link rel="prefetch" href="/assets/js/120.993eb659.js"><link rel="prefetch" href="/assets/js/121.91eabb47.js"><link rel="prefetch" href="/assets/js/122.5dd0e20b.js"><link rel="prefetch" href="/assets/js/123.bf8487e0.js"><link rel="prefetch" href="/assets/js/124.ef736623.js"><link rel="prefetch" href="/assets/js/125.3551f34f.js"><link rel="prefetch" href="/assets/js/126.22f20917.js"><link rel="prefetch" href="/assets/js/127.70b4085f.js"><link rel="prefetch" href="/assets/js/128.fce6d6c1.js"><link rel="prefetch" href="/assets/js/129.eebeeeab.js"><link rel="prefetch" href="/assets/js/13.d19e71e7.js"><link rel="prefetch" href="/assets/js/130.85411c7a.js"><link rel="prefetch" href="/assets/js/131.3fca59eb.js"><link rel="prefetch" href="/assets/js/132.25b456b1.js"><link rel="prefetch" href="/assets/js/133.ec7f2575.js"><link rel="prefetch" href="/assets/js/134.6eb7d7b9.js"><link rel="prefetch" href="/assets/js/135.af6d168b.js"><link rel="prefetch" href="/assets/js/136.8be0a8ae.js"><link rel="prefetch" href="/assets/js/137.77d58955.js"><link rel="prefetch" href="/assets/js/138.b8831210.js"><link rel="prefetch" href="/assets/js/139.cb137b06.js"><link rel="prefetch" href="/assets/js/14.add2b9d1.js"><link rel="prefetch" href="/assets/js/140.ce022ddc.js"><link rel="prefetch" href="/assets/js/141.eb1ca496.js"><link rel="prefetch" href="/assets/js/142.7b71b730.js"><link rel="prefetch" href="/assets/js/143.bd7e5c17.js"><link rel="prefetch" href="/assets/js/144.dd4a340f.js"><link rel="prefetch" href="/assets/js/145.88dc409a.js"><link rel="prefetch" href="/assets/js/146.587cf339.js"><link rel="prefetch" href="/assets/js/147.0c6cb42f.js"><link rel="prefetch" href="/assets/js/148.cde21382.js"><link rel="prefetch" href="/assets/js/149.57eb32ce.js"><link rel="prefetch" href="/assets/js/15.a7aa72c2.js"><link rel="prefetch" href="/assets/js/150.13c70aa7.js"><link rel="prefetch" href="/assets/js/151.860bec6e.js"><link rel="prefetch" href="/assets/js/152.a773d846.js"><link rel="prefetch" href="/assets/js/153.b79da999.js"><link rel="prefetch" href="/assets/js/154.90f51676.js"><link rel="prefetch" href="/assets/js/155.85fc9cca.js"><link rel="prefetch" href="/assets/js/156.55b47274.js"><link rel="prefetch" href="/assets/js/157.7efb004d.js"><link rel="prefetch" href="/assets/js/158.0da04a2c.js"><link rel="prefetch" href="/assets/js/159.846f8392.js"><link rel="prefetch" href="/assets/js/16.1ca91cef.js"><link rel="prefetch" href="/assets/js/160.1162f9b8.js"><link rel="prefetch" href="/assets/js/161.daace554.js"><link rel="prefetch" href="/assets/js/162.c76db0ce.js"><link rel="prefetch" href="/assets/js/163.2922410c.js"><link rel="prefetch" href="/assets/js/164.d8677450.js"><link rel="prefetch" href="/assets/js/165.c1cd35cf.js"><link rel="prefetch" href="/assets/js/166.34353f65.js"><link rel="prefetch" href="/assets/js/167.53b5f90d.js"><link rel="prefetch" href="/assets/js/168.d1372efa.js"><link rel="prefetch" href="/assets/js/169.44b88d34.js"><link rel="prefetch" href="/assets/js/17.bfc3e676.js"><link rel="prefetch" href="/assets/js/170.2b7c10df.js"><link rel="prefetch" href="/assets/js/171.5d9bfbf8.js"><link rel="prefetch" href="/assets/js/172.83f4beda.js"><link rel="prefetch" href="/assets/js/173.672f9679.js"><link rel="prefetch" href="/assets/js/174.854c72cd.js"><link rel="prefetch" href="/assets/js/175.4bb04152.js"><link rel="prefetch" href="/assets/js/176.3cf0876d.js"><link rel="prefetch" href="/assets/js/177.479a4ce4.js"><link rel="prefetch" href="/assets/js/178.f4236b6b.js"><link rel="prefetch" href="/assets/js/179.0ffac3fc.js"><link rel="prefetch" href="/assets/js/18.a7ccbc8f.js"><link rel="prefetch" href="/assets/js/180.0349746e.js"><link rel="prefetch" href="/assets/js/181.b382b91a.js"><link rel="prefetch" href="/assets/js/182.45ea1be0.js"><link rel="prefetch" href="/assets/js/183.d97ff0f2.js"><link rel="prefetch" href="/assets/js/184.04db3fa2.js"><link rel="prefetch" href="/assets/js/185.06886175.js"><link rel="prefetch" href="/assets/js/186.1e507894.js"><link rel="prefetch" href="/assets/js/187.2d443b36.js"><link rel="prefetch" href="/assets/js/188.47ac887d.js"><link rel="prefetch" href="/assets/js/189.588ea60e.js"><link rel="prefetch" href="/assets/js/19.fb710d2b.js"><link rel="prefetch" href="/assets/js/190.427f20ae.js"><link rel="prefetch" href="/assets/js/191.74e4417a.js"><link rel="prefetch" href="/assets/js/192.ecd17749.js"><link rel="prefetch" href="/assets/js/193.34698712.js"><link rel="prefetch" href="/assets/js/194.3af39153.js"><link rel="prefetch" href="/assets/js/195.e2d999ff.js"><link rel="prefetch" href="/assets/js/196.2585faf4.js"><link rel="prefetch" href="/assets/js/197.1b4f726d.js"><link rel="prefetch" href="/assets/js/198.78a41910.js"><link rel="prefetch" href="/assets/js/199.13fc9f5f.js"><link rel="prefetch" href="/assets/js/20.9b50ffb2.js"><link rel="prefetch" href="/assets/js/200.704d8809.js"><link rel="prefetch" href="/assets/js/201.4e7b7c78.js"><link rel="prefetch" href="/assets/js/202.5b83bc37.js"><link rel="prefetch" href="/assets/js/203.20cafd87.js"><link rel="prefetch" href="/assets/js/204.e13a329c.js"><link rel="prefetch" href="/assets/js/205.70cbfd9d.js"><link rel="prefetch" href="/assets/js/206.b24a6498.js"><link rel="prefetch" href="/assets/js/207.c1f54a7b.js"><link rel="prefetch" href="/assets/js/208.b42ff2a7.js"><link rel="prefetch" href="/assets/js/209.025d3bc5.js"><link rel="prefetch" href="/assets/js/21.7fc2c3c0.js"><link rel="prefetch" href="/assets/js/210.fdac89cc.js"><link rel="prefetch" href="/assets/js/211.856ce748.js"><link rel="prefetch" href="/assets/js/212.b3203755.js"><link rel="prefetch" href="/assets/js/213.6573a28e.js"><link rel="prefetch" href="/assets/js/214.2134f64a.js"><link rel="prefetch" href="/assets/js/215.083a9e85.js"><link rel="prefetch" href="/assets/js/216.57a091f2.js"><link rel="prefetch" href="/assets/js/217.cfad87ef.js"><link rel="prefetch" href="/assets/js/218.d84ebfbf.js"><link rel="prefetch" href="/assets/js/219.839d2285.js"><link rel="prefetch" href="/assets/js/22.715a7176.js"><link rel="prefetch" href="/assets/js/220.d12122eb.js"><link rel="prefetch" href="/assets/js/221.2bbdc524.js"><link rel="prefetch" href="/assets/js/222.ffb4c7db.js"><link rel="prefetch" href="/assets/js/223.d6779006.js"><link rel="prefetch" href="/assets/js/224.ca7b9a36.js"><link rel="prefetch" href="/assets/js/225.65f7cf7a.js"><link rel="prefetch" href="/assets/js/226.2f8fc6e2.js"><link rel="prefetch" href="/assets/js/227.a3ee9541.js"><link rel="prefetch" href="/assets/js/228.fa88d7b3.js"><link rel="prefetch" href="/assets/js/229.d2287ac3.js"><link rel="prefetch" href="/assets/js/23.7cc08dae.js"><link rel="prefetch" href="/assets/js/230.78a12551.js"><link rel="prefetch" href="/assets/js/231.29c15b3f.js"><link rel="prefetch" href="/assets/js/232.4d55e308.js"><link rel="prefetch" href="/assets/js/233.fe9f330b.js"><link rel="prefetch" href="/assets/js/234.3cd7f9e8.js"><link rel="prefetch" href="/assets/js/235.88874d60.js"><link rel="prefetch" href="/assets/js/236.d30e0441.js"><link rel="prefetch" href="/assets/js/237.5bceaca4.js"><link rel="prefetch" href="/assets/js/238.d72d8310.js"><link rel="prefetch" href="/assets/js/239.7610035e.js"><link rel="prefetch" href="/assets/js/24.039ee5f1.js"><link rel="prefetch" href="/assets/js/240.12b18259.js"><link rel="prefetch" href="/assets/js/241.e3d28483.js"><link rel="prefetch" href="/assets/js/242.3f37dd43.js"><link rel="prefetch" href="/assets/js/243.ada242d5.js"><link rel="prefetch" href="/assets/js/244.77d0d090.js"><link rel="prefetch" href="/assets/js/245.1c5cb9be.js"><link rel="prefetch" href="/assets/js/246.8d72f493.js"><link rel="prefetch" href="/assets/js/247.00962acf.js"><link rel="prefetch" href="/assets/js/248.f8f7aaf9.js"><link rel="prefetch" href="/assets/js/249.980b6ec6.js"><link rel="prefetch" href="/assets/js/25.dec20d17.js"><link rel="prefetch" href="/assets/js/250.c61aee6f.js"><link rel="prefetch" href="/assets/js/251.f096bb18.js"><link rel="prefetch" href="/assets/js/252.0663ea3d.js"><link rel="prefetch" href="/assets/js/253.be02497e.js"><link rel="prefetch" href="/assets/js/254.7af2d67c.js"><link rel="prefetch" href="/assets/js/255.7c4ba5e4.js"><link rel="prefetch" href="/assets/js/256.99a3a5a3.js"><link rel="prefetch" href="/assets/js/257.496e55b4.js"><link rel="prefetch" href="/assets/js/258.0e780483.js"><link rel="prefetch" href="/assets/js/259.5e859f0e.js"><link rel="prefetch" href="/assets/js/26.aad5fbf0.js"><link rel="prefetch" href="/assets/js/260.301554ac.js"><link rel="prefetch" href="/assets/js/261.80b7eca1.js"><link rel="prefetch" href="/assets/js/262.eaaba93a.js"><link rel="prefetch" href="/assets/js/263.af5b179f.js"><link rel="prefetch" href="/assets/js/264.219ac8df.js"><link rel="prefetch" href="/assets/js/265.7ec04094.js"><link rel="prefetch" href="/assets/js/266.8c34db6a.js"><link rel="prefetch" href="/assets/js/267.db88eae1.js"><link rel="prefetch" href="/assets/js/268.fccf8b81.js"><link rel="prefetch" href="/assets/js/269.7edf2854.js"><link rel="prefetch" href="/assets/js/27.0d3eeb1c.js"><link rel="prefetch" href="/assets/js/270.27ba6bda.js"><link rel="prefetch" href="/assets/js/271.b52774aa.js"><link rel="prefetch" href="/assets/js/272.63c82e0b.js"><link rel="prefetch" href="/assets/js/273.2b2b816a.js"><link rel="prefetch" href="/assets/js/274.1420285e.js"><link rel="prefetch" href="/assets/js/275.20c3ffb2.js"><link rel="prefetch" href="/assets/js/276.ba2ba72d.js"><link rel="prefetch" href="/assets/js/277.ca678acc.js"><link rel="prefetch" href="/assets/js/278.b76a2675.js"><link rel="prefetch" href="/assets/js/279.32c5b1ab.js"><link rel="prefetch" href="/assets/js/28.037ed440.js"><link rel="prefetch" href="/assets/js/280.ee764623.js"><link rel="prefetch" href="/assets/js/281.296dd9d9.js"><link rel="prefetch" href="/assets/js/283.2a5b9e15.js"><link rel="prefetch" href="/assets/js/284.6b7af45b.js"><link rel="prefetch" href="/assets/js/285.415ab5cd.js"><link rel="prefetch" href="/assets/js/286.bc0040ae.js"><link rel="prefetch" href="/assets/js/29.e52a9d90.js"><link rel="prefetch" href="/assets/js/30.5236c1bc.js"><link rel="prefetch" href="/assets/js/31.47ca8aab.js"><link rel="prefetch" href="/assets/js/32.a7a02a99.js"><link rel="prefetch" href="/assets/js/33.65976515.js"><link rel="prefetch" href="/assets/js/34.2da58a6a.js"><link rel="prefetch" href="/assets/js/35.5284e75e.js"><link rel="prefetch" href="/assets/js/36.446ea69b.js"><link rel="prefetch" href="/assets/js/37.6170733e.js"><link rel="prefetch" href="/assets/js/38.4e800202.js"><link rel="prefetch" href="/assets/js/39.1729ae1c.js"><link rel="prefetch" href="/assets/js/4.10543b34.js"><link rel="prefetch" href="/assets/js/40.f6d02ad2.js"><link rel="prefetch" href="/assets/js/41.bb74528d.js"><link rel="prefetch" href="/assets/js/42.06cea1eb.js"><link rel="prefetch" href="/assets/js/43.77b26dc8.js"><link rel="prefetch" href="/assets/js/44.15101d20.js"><link rel="prefetch" href="/assets/js/45.1f3d695e.js"><link rel="prefetch" href="/assets/js/46.3396517f.js"><link rel="prefetch" href="/assets/js/47.aaa8a50e.js"><link rel="prefetch" href="/assets/js/48.a1986c37.js"><link rel="prefetch" href="/assets/js/49.db5b026a.js"><link rel="prefetch" href="/assets/js/5.d0f450bd.js"><link rel="prefetch" href="/assets/js/50.40ac975f.js"><link rel="prefetch" href="/assets/js/51.c36c9269.js"><link rel="prefetch" href="/assets/js/52.40d65fd0.js"><link rel="prefetch" href="/assets/js/53.c165027a.js"><link rel="prefetch" href="/assets/js/54.6568d816.js"><link rel="prefetch" href="/assets/js/55.b22b5348.js"><link rel="prefetch" href="/assets/js/56.c8d66f18.js"><link rel="prefetch" href="/assets/js/57.2360da04.js"><link rel="prefetch" href="/assets/js/58.002a9b2f.js"><link rel="prefetch" href="/assets/js/59.80ea1446.js"><link rel="prefetch" href="/assets/js/6.24060e60.js"><link rel="prefetch" href="/assets/js/60.2ffa491c.js"><link rel="prefetch" href="/assets/js/61.d1ba9295.js"><link rel="prefetch" href="/assets/js/62.77818eb4.js"><link rel="prefetch" href="/assets/js/63.37359d58.js"><link rel="prefetch" href="/assets/js/64.8815086a.js"><link rel="prefetch" href="/assets/js/65.7a939c94.js"><link rel="prefetch" href="/assets/js/66.e49d453d.js"><link rel="prefetch" href="/assets/js/67.6aceb9b9.js"><link rel="prefetch" href="/assets/js/68.98753229.js"><link rel="prefetch" href="/assets/js/69.07dfa16b.js"><link rel="prefetch" href="/assets/js/7.b8bf6b3f.js"><link rel="prefetch" href="/assets/js/70.9da04b45.js"><link rel="prefetch" href="/assets/js/71.59a42831.js"><link rel="prefetch" href="/assets/js/72.7d4af0fa.js"><link rel="prefetch" href="/assets/js/73.c0481ff8.js"><link rel="prefetch" href="/assets/js/74.3c19f028.js"><link rel="prefetch" href="/assets/js/75.eb0b4a24.js"><link rel="prefetch" href="/assets/js/76.32002664.js"><link rel="prefetch" href="/assets/js/77.6146716f.js"><link rel="prefetch" href="/assets/js/78.d7fc6256.js"><link rel="prefetch" href="/assets/js/79.841f0d44.js"><link rel="prefetch" href="/assets/js/8.024a3703.js"><link rel="prefetch" href="/assets/js/80.04f40382.js"><link rel="prefetch" href="/assets/js/81.baf9eaf4.js"><link rel="prefetch" href="/assets/js/82.82e2cd4b.js"><link rel="prefetch" href="/assets/js/83.508e9bc6.js"><link rel="prefetch" href="/assets/js/84.ff8f727a.js"><link rel="prefetch" href="/assets/js/85.b88ebfaf.js"><link rel="prefetch" href="/assets/js/86.68de79a4.js"><link rel="prefetch" href="/assets/js/87.4f2ac4cc.js"><link rel="prefetch" href="/assets/js/88.221a9d92.js"><link rel="prefetch" href="/assets/js/89.e2928c4d.js"><link rel="prefetch" href="/assets/js/9.d630a5e2.js"><link rel="prefetch" href="/assets/js/90.09bb8952.js"><link rel="prefetch" href="/assets/js/91.27f5fda2.js"><link rel="prefetch" href="/assets/js/92.a9fb67dd.js"><link rel="prefetch" href="/assets/js/93.5bd59d9e.js"><link rel="prefetch" href="/assets/js/94.ff1cee5f.js"><link rel="prefetch" href="/assets/js/95.2d7759a8.js"><link rel="prefetch" href="/assets/js/96.5b1279d7.js"><link rel="prefetch" href="/assets/js/97.c4efd893.js"><link rel="prefetch" href="/assets/js/98.a49b59f7.js"><link rel="prefetch" href="/assets/js/99.1653d757.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f7a51907.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-11f94078><div data-v-11f94078><div class="password-shadow password-wrapper-out" style="display:none;" data-v-08f61db9 data-v-11f94078 data-v-11f94078><h3 class="title" data-v-08f61db9>Auraro's Blog</h3> <p class="description" data-v-08f61db9>面向对象面向君，不负代码不负卿。</p> <label id="box" class="inputBox" data-v-08f61db9><input type="password" value="" data-v-08f61db9> <span data-v-08f61db9>Konck! Knock!</span> <button data-v-08f61db9>OK</button></label> <div class="footer" data-v-08f61db9><span data-v-08f61db9><i class="iconfont reco-theme" data-v-08f61db9></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-08f61db9>vuePress-theme-reco</a></span> <span data-v-08f61db9><i class="iconfont reco-copyright" data-v-08f61db9></i> <a data-v-08f61db9><span data-v-08f61db9>AuraroJ</span>
          
        <!---->
        2022
      </a></span></div></div> <div class="hide" data-v-11f94078><header class="navbar" data-v-11f94078><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Auraro's Blog" class="logo"> <span class="site-name">Auraro's Blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  随性一点的主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/随笔/me.html" class="nav-link"><i class="undefined"></i>
  随笔
</a></li><li class="dropdown-item"><!----> <a href="/面经/" class="nav-link"><i class="undefined"></i>
  面经
</a></li><li class="dropdown-item"><!----> <a href="/network/浏览器输入url过程.html" class="nav-link"><i class="undefined"></i>
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/Os/段式存储和页式存储.html" class="nav-link"><i class="undefined"></i>
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/中间件/" class="nav-link"><i class="undefined"></i>
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/Java-框架/" class="nav-link"><i class="undefined"></i>
  Java框架
</a></li><li class="dropdown-item"><!----> <a href="/Linux/常见面试题.html" class="nav-link"><i class="undefined"></i>
  Linux
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  随笔标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      项目
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>底层项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.830 JAVA
</a></li><li class="dropdown-subitem"><a href="/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.s081 C
</a></li><li class="dropdown-subitem"><a href="/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.824 GO
</a></li></ul></li><li class="dropdown-item"><h4>游戏项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/项目/" class="nav-link"><i class="undefined"></i>
  AI对抗平台 JAVA
</a></li></ul></li><li class="dropdown-item"><h4>合作项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/项目/" class="nav-link"><i class="undefined"></i>
  仿北邮人论坛 JAVA
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      算法
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/LeetCode/" class="nav-link"><i class="undefined"></i>
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      人工智能
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/论文/" class="nav-link"><i class="undefined"></i>
  漏洞检测
</a></li></ul></div></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  归档
</a></div><div class="nav-item"><a href="/review.html" class="nav-link"><i class="iconfont reco-blog"></i>
  回顾
</a></div><div class="nav-item"><a href="/aboutme.html" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-11f94078></div> <aside class="sidebar" data-v-11f94078><div class="personal-info-wrapper" data-v-3d87d2e4 data-v-11f94078><img src="/logo.png" alt="author-avatar" class="personal-img" data-v-3d87d2e4> <h3 class="name" data-v-3d87d2e4>
    AuraroJ
  </h3> <div class="num" data-v-3d87d2e4><div data-v-3d87d2e4><h3 data-v-3d87d2e4>65</h3> <h6 data-v-3d87d2e4>文章</h6></div> <div data-v-3d87d2e4><h3 data-v-3d87d2e4>29</h3> <h6 data-v-3d87d2e4>标签</h6></div></div> <ul class="social-links" data-v-3d87d2e4></ul> <hr data-v-3d87d2e4></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  随性一点的主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/随笔/me.html" class="nav-link"><i class="undefined"></i>
  随笔
</a></li><li class="dropdown-item"><!----> <a href="/面经/" class="nav-link"><i class="undefined"></i>
  面经
</a></li><li class="dropdown-item"><!----> <a href="/network/浏览器输入url过程.html" class="nav-link"><i class="undefined"></i>
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/Os/段式存储和页式存储.html" class="nav-link"><i class="undefined"></i>
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/中间件/" class="nav-link"><i class="undefined"></i>
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/Java-框架/" class="nav-link"><i class="undefined"></i>
  Java框架
</a></li><li class="dropdown-item"><!----> <a href="/Linux/常见面试题.html" class="nav-link"><i class="undefined"></i>
  Linux
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  随笔标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      项目
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>底层项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.830 JAVA
</a></li><li class="dropdown-subitem"><a href="/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.s081 C
</a></li><li class="dropdown-subitem"><a href="/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.824 GO
</a></li></ul></li><li class="dropdown-item"><h4>游戏项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/项目/" class="nav-link"><i class="undefined"></i>
  AI对抗平台 JAVA
</a></li></ul></li><li class="dropdown-item"><h4>合作项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/项目/" class="nav-link"><i class="undefined"></i>
  仿北邮人论坛 JAVA
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      算法
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/LeetCode/" class="nav-link"><i class="undefined"></i>
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      人工智能
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/论文/" class="nav-link"><i class="undefined"></i>
  漏洞检测
</a></li></ul></div></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  归档
</a></div><div class="nav-item"><a href="/review.html" class="nav-link"><i class="iconfont reco-blog"></i>
  回顾
</a></div><div class="nav-item"><a href="/aboutme.html" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>MIT项目</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>MIT数据库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>MIT操作系统</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/项目/MIT6.s081/lab1 Xv6 and Unix utilities.html" class="sidebar-link">操作系统lab1 Xv6 and Unix utilities</a></li><li><a href="/项目/MIT6.s081/lab2 system calls.html" class="sidebar-link">操作系统lab2 system calls</a></li><li><a href="/项目/MIT6.s081/lab3 Page tables.html" class="sidebar-link">操作系统lab3 Page tables</a></li><li><a href="/项目/MIT6.s081/lab4 Trap.html" class="sidebar-link">操作系统lab4 Trap</a></li><li><a href="/项目/MIT6.s081/lab5 Lazy allocation.html" class="sidebar-link">操作系统lab5 Lazy allocation</a></li><li><a href="/项目/MIT6.s081/lab6 Copy-on-write fork.html" class="sidebar-link">操作系统lab6 Copy-on-write fork</a></li><li><a href="/项目/MIT6.s081/lab7 Multithreading.html" class="sidebar-link">操作系统lab7 Multithreading</a></li><li><a href="/项目/MIT6.s081/lab8 locks.html" class="active sidebar-link">操作系统lab8 locks</a></li><li><a href="/项目/MIT6.s081/lab9 file system.html" class="sidebar-link">操作系统lab9 file system</a></li><li><a href="/项目/MIT6.s081/lab10 mmap.html" class="sidebar-link">操作系统lab10 mmap</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>MIT分布式系统</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>游戏项目</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>仿北邮人论坛</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-08f61db9 data-v-11f94078><h3 class="title" data-v-08f61db9>操作系统lab8 locks</h3> <!----> <label id="box" class="inputBox" data-v-08f61db9><input type="password" value="" data-v-08f61db9> <span data-v-08f61db9>Konck! Knock!</span> <button data-v-08f61db9>OK</button></label> <div class="footer" data-v-08f61db9><span data-v-08f61db9><i class="iconfont reco-theme" data-v-08f61db9></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-08f61db9>vuePress-theme-reco</a></span> <span data-v-08f61db9><i class="iconfont reco-copyright" data-v-08f61db9></i> <a data-v-08f61db9><span data-v-08f61db9>AuraroJ</span>
          
        <!---->
        2022
      </a></span></div></div> <div data-v-11f94078><div data-v-11f94078><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">操作系统lab8 locks</h1> <div data-v-162cc157><i class="iconfont reco-account" data-v-162cc157><span data-v-162cc157>AuraroJ</span></i> <i class="iconfont reco-date" data-v-162cc157><span data-v-162cc157>2022/9/28</span></i> <i class="iconfont reco-eye" data-v-162cc157><span id="/%E9%A1%B9%E7%9B%AE/MIT6.s081/lab8%20locks.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-162cc157><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <!----></div></div> <div class="theme-reco-content content__default"><h2 id="一、memory-allocator"><a href="#一、memory-allocator" class="header-anchor">#</a> 一、Memory allocator</h2> <h3 id="预处理"><a href="#预处理" class="header-anchor">#</a> 预处理</h3> <ul><li>在 xv6 中运行 <code>kalloctest</code>, 输出如下:</li></ul> <p><img src="https://img-blog.csdnimg.cn/3e16c783374843bba51879582940f0bc.png" alt="在这里插入图片描述"></p> <p>可以看到, test1 测试失败. 结合实验中 <code>struct spinlock</code> 的字段和相关代码可以得到, <code>kmem</code> 锁的争用情况: <code>acquire()</code> 被调用了 433016 次, 且自旋尝试获取锁的次数为 3427124 次, 同时 <code>kmem</code> 锁也是最具争用性的 5 个锁之一.</p> <h3 id="要点"><a href="#要点" class="header-anchor">#</a> 要点</h3> <ul><li>重新设计内存分配器, 避免使用单个锁和单个空闲内存页链表, 以达到减轻所争用.</li> <li>每个 CPU 都有其自己的空闲内存页链表和对应的锁.</li> <li>当前 CPU 的空闲内存页链表为空时要能偷取其他 CPU 的空闲内存页链表</li> <li><code>cpuid()</code>函数返回当前的 CPU 核序号, 但需要在前后关闭中断</li></ul> <h3 id="步骤"><a href="#步骤" class="header-anchor">#</a> 步骤</h3> <ul><li><p>构造内存页 kmems 数组.根据指导书要求, 此处每个 CPU 需要有一个空闲内存页链表以及相应的锁, 即将原本在 kernel/kalloc.c 中定义的 kmem 结构体替换为 kmems 数组, 数组的大小即为 CPU 的核心数 NCPU.
此处为 kmems 结构体额外添加了一个 lockname 的字段, 用于记录每个锁的名称.</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">spinlock</span> lock<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>freelist<span class="token punctuation">;</span>
  <span class="token keyword">char</span> lockname<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">// save lock's name </span>
<span class="token punctuation">}</span> kmems<span class="token punctuation">[</span>NCPU<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// a free list and a lock per CPU </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>修改初始化函数 kinit().kinit() 函数中主要会初始化 kmem 的锁并调用 freearrange() 初始化分配物理页.
由于此处 kmems 是一个数组, 因此这里需要将原本对 kmem 中锁的初始化替换为一个初始化 kmems 数组中锁的循环.
这里利用了 snprintf() 函数来设置每个锁的名称, 将名称存储到 lockname 字段. 之所以这样做, 是因为在 initlock() 函数中, 锁名称的记录是指针的浅拷贝 lk-&gt;name=name, 因此对于每个锁的名称需要使用全局的内存进行记录而非函数的局部变量, 以防止内存丢失. 此外, 为了配合 kalloctest 的输出, 需要保证每个锁的名称以&quot;kmem&quot;开头.</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span>
<span class="token function">kinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">// init the kmem array</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NCPU<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">snprintf</span><span class="token punctuation">(</span>kmems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lockname<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">&quot;kmem_%d&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// the name of the lock</span>
    <span class="token function">initlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">,</span> kmems<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lockname<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//  initlock(&amp;kmem.lock, &quot;kmem&quot;);   // lab8-1</span>
  <span class="token function">freerange</span><span class="token punctuation">(</span>end<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>PHYSTOP<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li> <li><p>修改 kfree() 函数.kfree() 函数用于回收物理页到 freelist. 指导书要求初始时 freearrange() 将空闲内存分配给当前运行 CPU 的 freelist. 而 freearrange() 内部就是调用 kfree() 进行的内存回收. 同样的, 这里我们也将每次调用 kfree() 释放的物理页由当前运行的 CPU 的 freelist 进行回收.
修改方法比较简单, 即使用 cpuid() 函数获取当前 CPU 核心的序号, 使用 kmems 中对应的锁和 freelist 进行回收.</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span>
<span class="token function">kfree</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pa<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>r<span class="token punctuation">;</span>
  <span class="token keyword">int</span> c<span class="token punctuation">;</span>    <span class="token comment">// cpuid - lab8-1</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa <span class="token operator">%</span> PGSIZE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>pa <span class="token operator">&lt;</span> end <span class="token operator">||</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span>pa <span class="token operator">&gt;=</span> PHYSTOP<span class="token punctuation">)</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;kfree&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Fill with junk to catch dangling refs.</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>pa<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

  r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">run</span><span class="token operator">*</span><span class="token punctuation">)</span>pa<span class="token punctuation">;</span>

  <span class="token comment">// get the current core number - lab8-1</span>
  <span class="token function">push_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  c <span class="token operator">=</span> <span class="token function">cpuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pop_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// free the page to the current cpu's freelist - lab8-1</span>
  <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  r<span class="token operator">-&gt;</span>next <span class="token operator">=</span> kmems<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist<span class="token punctuation">;</span>
  kmems<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist <span class="token operator">=</span> r<span class="token punctuation">;</span>
  <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div></li> <li><p>修改 kalloc() 函数.与 kfree() 函数回收物理页相对的, 就是 kalloc() 函数进行物理页的分配.
此处先不考虑偷取其他 CPU 的空闲物理页. 同样的, 需要调用 cpuid() 获取当前 CPU 核心的序号, 使用 kmems 中对应的锁和 freelist 进行物理页的分配.</p></li> <li><p>编写偷取物理页函数 <code>steal()</code>.  最后考虑偷取物理页的情况: 当前 CPU 的空闲物理页链表 <code>freelist</code> 为空, 但此时其他 CPU 可能仍有空闲物理页, 因此需要当前 CPU 去偷取其他 CPU 的部分物理页.</p></li> <li><p>首先考虑寻找仍有空闲物理页的 CPU 的方法, 此处便是选择的最为简单的循环遍历: 从当前 CPU 序号的下一个开始, 循环 NCPU-1 次, 即<strong>依次遍历剩余的 CPU 的空闲物理页链表, 直到找到一个链表不为空的</strong>.</p></li> <li><p>接下来考虑偷取物理页的数量, 指导书中仅说明为&quot;部分&quot;, 此处选择的是偷取目标 CPU 一半的空闲物理页, 即对于 n 个空闲物理页偷取 ⌈ n / 2 ⌉ 个物理页. 由于物理页是通过单向链表组织的, 因此此处采用了&quot;快慢双指针&quot;的算法来得到链表的中间结点, 将原链表一分为二, 后半部分作为目标 CPU 剩余的空闲物理页, 前半部分即偷取到的物理页.</p></li> <li><p>最后考虑加锁的问题.
首先可以肯定的是, 在遍历寻找有空闲物理页的 CPU 时以及使用算法分割链表的过程中, 是需要使用当前 CPU 的锁进行加锁的.接下来考虑当前需要偷取的 CPU 的加锁情况, 根据分析可以看到, 在偷取时, 只是寻找其他 CPU 的空闲物理页, 对其他 CPU 的链表可能进行操作, 但不影响当前 CPU 的链表, 因此此时不能对当前 CPU 的空闲物理页链表加锁. 一旦加锁, 如若此时有另一个 CPU 同样要偷取其他 CPU 的物理页而遍历到当前 CPU 尝试获取其锁, 二者便会发生死锁.
经过再次考虑, 会发现若不同时加锁也会有一定的问题, 但由于此处对于一个 CPU 而言不可能同时运行两个线程, 因此不会出现两个线程同时读取到同一 CPU 的空闲物理页为空然后同时去偷取其他 CPU 物理页致使的内存丢失情况.而最后分割获取到偷取到的空闲物理页, 对当前 CPU 的空闲物理页链表进行更新时, 再进行加锁.</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span><span class="token function">steal</span><span class="token punctuation">(</span><span class="token keyword">int</span> cpu_id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> cpu_id<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>fast<span class="token punctuation">,</span> <span class="token operator">*</span>slow<span class="token punctuation">,</span> <span class="token operator">*</span>head<span class="token punctuation">;</span>
    <span class="token comment">// 若传递的cpuid和实际运行的cpuid出现不一致,则引发panic</span>
    <span class="token comment">// 加入该判断以检查在kalloc()调用steal时CPU不会被切换</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>cpu_id <span class="token operator">!=</span> <span class="token function">cpuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;steal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
    <span class="token comment">// 遍历其他NCPU-1个CPU的空闲物理页链表 </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NCPU<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>c <span class="token operator">==</span> NCPU<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 若链表不为空</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>kmems<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 快慢双指针算法将链表一分为二</span>
            slow <span class="token operator">=</span> head <span class="token operator">=</span> kmems<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist<span class="token punctuation">;</span>
            fast <span class="token operator">=</span> slow<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>fast<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                fast <span class="token operator">=</span> fast<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fast<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    slow <span class="token operator">=</span> slow<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
                    fast <span class="token operator">=</span> fast<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 后半部分作为当前CPU的空闲链表</span>
            kmems<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist <span class="token operator">=</span> slow<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
            <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 前半部分的链表结尾清空,由于该部分链表与其他链表不再关联,因此无需加锁</span>
            slow<span class="token operator">-&gt;</span>next <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment">// 返回前半部分的链表头</span>
            <span class="token keyword">return</span> head<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 若其他CPU物理页均为空则返回空指针</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Allocate one 4096-byte page of physical memory.</span>
<span class="token comment">// Returns a pointer that the kernel can use.</span>
<span class="token comment">// Returns 0 if the memory cannot be allocated.</span>
<span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">run</span> <span class="token operator">*</span>r<span class="token punctuation">;</span>
  <span class="token keyword">int</span> c<span class="token punctuation">;</span>
  <span class="token function">push_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  c <span class="token operator">=</span> <span class="token function">cpuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pop_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// get the page from the current cpu's freelist</span>
  <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  r <span class="token operator">=</span> kmems<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
    kmems<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist <span class="token operator">=</span> r<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
  <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 若当前CPU空闲物理页为空,且偷取到了物理页</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>r <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token function">steal</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 加锁修改当前CPU空闲物理页链表</span>
    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    kmems<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">.</span>freelist <span class="token operator">=</span> r<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kmems<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>r<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// fill with junk</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div></li></ul> <h3 id="结果"><a href="#结果" class="header-anchor">#</a> 结果</h3> <ul><li>在 xv6 中执行 kalloctest, 输出如下, 可以看到对于每个 CPU 的物理页锁的争用情况相比之前有明显下降, acquire() 整体次数大幅减少, 最多被调用了 178033 次, 比修改前次数减少了一半多, 且自旋尝试获取锁的次数均为 0 次. 同时 kmems 中的锁也不再是最具争用性的 5 个锁. 测试 test1 和 test2 也均通过</li></ul> <p><img src="https://img-blog.csdnimg.cn/7c2c528fe0034e0aa8435af94713e3e1.png" alt="在这里插入图片描述"></p> <ul><li>在 xv6 中执行 <code>usertests sbrkmuch</code> 进行测试:</li></ul> <p><img src="https://img-blog.csdnimg.cn/1e26ab8e6cf54992b846a828fe0ecce9.png" alt="在这里插入图片描述"></p> <ul><li>在 xv6 中执行 <code>usertests</code>测试:</li></ul> <p><img src="https://img-blog.csdnimg.cn/3fffae89ccf94b9fb4e0d2411e952f07.png" alt="在这里插入图片描述"></p> <h2 id="二、buffer-cache"><a href="#二、buffer-cache" class="header-anchor">#</a> 二、Buffer cache</h2> <h3 id="预处理-2"><a href="#预处理-2" class="header-anchor">#</a> 预处理</h3> <ul><li>在xv6中运行<code>bcachetest</code>,输出如下:</li></ul> <p><img src="https://img-blog.csdnimg.cn/4d37bae0fe6149d7a6787a813ac53429.png" alt="在这里插入图片描述"></p> <p>可以看到, test0 测试失败. 其中<code>bcache</code> 锁的争用情况: <code>acquire()</code> 被调用了 1760378 次, 且自旋尝试获取锁的次数为 743833 次, 同时 <code>bcache</code> 锁也是最具争用性的 5 个锁之一.</p> <h3 id="要点-2"><a href="#要点-2" class="header-anchor">#</a> 要点</h3> <ul><li>修改 <code>bget()</code> 和 <code>brelse()</code> 以尽可能减少锁争用.</li> <li>使用线程安全的哈希表来寻找cache 中的块号</li> <li>移除缓冲区的链表结构, 使用最近使用时间的时间戳的缓冲区来代替.</li></ul> <h3 id="思路"><a href="#思路" class="header-anchor">#</a> 思路</h3> <ul><li>将原本管理缓存块的双向链表移除, 采用哈希表来管理, 这样<strong>每个 bucket 有一个锁</strong>而非只有一个 bcache 的全局锁, 这样便可以减少锁的争用.</li> <li>此处仍然<strong>使用了一个 <code>bcache</code> 的全局锁, 用于初始分配缓存块到哈希表</strong>.此外, 对于<strong>整个哈希表, 也有一个全局锁</strong>, 因为当缓存块全部分配后, 是通过时间戳来寻找 bucket 中引用计数为 0 的缓存块, 对其进行重用, 此时可能会将其移至新的 bucket, 所以需要对哈希表整体加锁, 保证只有一个线程能够对哈希表整体操作, 保证其全局一致性.
这里 bcache 的全局锁和哈希表的全局锁是两个锁, 且不能使用一个代替. 具体见说明.</li> <li>此处的实现考虑了 bcachetest 中不会发生的并发场景: 包括两个线程并发使用同一块, 两个线程并发寻找未使用块的情况.</li></ul> <h3 id="步骤-2"><a href="#步骤-2" class="header-anchor">#</a> 步骤</h3> <ul><li><p>修改 <code>buf</code> 和 <code>bcache</code> 结构体</p> <ul><li>修改 <code>kernel/buf.h</code> 中的 <code>buf</code> 结构体.</li></ul> <p>由于此处不再使用双向链表而采用哈希表, 对于哈希表 bucket 中的链式结构, 此处笔者使用的是单向链表(当然双向链表同样可以满足), 所以不再需要 prev 字段.
此外, 由于对于寻找未使用的缓存块的 LRU 算法改成了基于时间戳比较的算法, 因此添加了 timestamp 字段用于记录最后使用缓存块的时间.</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> valid<span class="token punctuation">;</span>   <span class="token comment">// has data been read from disk?</span>
  <span class="token keyword">int</span> disk<span class="token punctuation">;</span>    <span class="token comment">// does disk &quot;own&quot; buf?</span>
  uint dev<span class="token punctuation">;</span>
  uint blockno<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">sleeplock</span> lock<span class="token punctuation">;</span>
  uint refcnt<span class="token punctuation">;</span>
<span class="token comment">//  struct buf *prev; // LRU cache list </span>
  <span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>     <span class="token comment">// hash list</span>
  uchar data<span class="token punctuation">[</span>BSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
  uint timestamp<span class="token punctuation">;</span>   <span class="token comment">// the buf last using time</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li><p>修改 kernel/bio.c 中的 bcache 结构体.
根据上文思路, 此处添加了 size 字段, 用于记录已经分配到哈希表的缓存块 struct buf 的数量; 添加了 buckets[NBUCKET] 数组, 作为哈希表的 bucket 数组, 其中 NBUCKET 为 bucket 的数目, 根据指导书此处设置为 13; 添加 locks[NBUCKET] 字段, 用于作为每个 bucket 对应的锁; 添加了 hashlock 字段, 作为哈希表的全局锁, 用于对哈希表整体加锁.</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// lab8-2</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NBUCKET</span> <span class="token expression"><span class="token number">13</span>      </span><span class="token comment">// the count of hash table's buckets</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">HASH</span><span class="token expression"><span class="token punctuation">(</span>blockno<span class="token punctuation">)</span> <span class="token punctuation">(</span>blockno <span class="token operator">%</span> NBUCKET<span class="token punctuation">)</span></span></span>

<span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">spinlock</span> lock<span class="token punctuation">;</span>   <span class="token comment">// used for the buf alloc and size</span>
  <span class="token keyword">struct</span> <span class="token class-name">buf</span> buf<span class="token punctuation">[</span>NBUF<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> size<span class="token punctuation">;</span>     <span class="token comment">// record the count of used buf - lab8-2</span>
  <span class="token keyword">struct</span> <span class="token class-name">buf</span> buckets<span class="token punctuation">[</span>NBUCKET<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// lab8-2</span>
  <span class="token keyword">struct</span> <span class="token class-name">spinlock</span> locks<span class="token punctuation">[</span>NBUCKET<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// buckets' locks - lab8-2</span>
  <span class="token keyword">struct</span> <span class="token class-name">spinlock</span> hashlock<span class="token punctuation">;</span>     <span class="token comment">// the hash table's lock - lab8-2</span>
  <span class="token comment">// Linked list of all buffers, through prev/next.</span>
  <span class="token comment">// Sorted by how recently the buffer was used.</span>
  <span class="token comment">// head.next is most recent, head.prev is least.</span>
<span class="token comment">//  struct buf head;    // lab8-2</span>
<span class="token punctuation">}</span> bcache<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></li></ul></li> <li><p>修改非主要函数</p> <ul><li><p>修改 kernel/bio.c 中的 binit() 函数.
该函数主要用于缓存块和相关锁的初始化.
由于不再使用双向链表, 因此相关的代码即可注释掉.
此外需要将新增的 size 字段, 以及哈希表的 bucket 数组的锁 locks[NBUCKET] 以及哈希表全局锁 hashlock 进行初始化.</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span>
<span class="token function">binit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>b<span class="token punctuation">;</span>

  bcache<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// lab8-2</span>
  <span class="token function">initlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>lock<span class="token punctuation">,</span> <span class="token string">&quot;bcache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">initlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>hashlock<span class="token punctuation">,</span> <span class="token string">&quot;bcache_hash&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// init hash lock - lab8-2</span>
  <span class="token comment">// init all buckets' locks  - lab8-2</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NBUCKET<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">initlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>locks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;bcache_bucket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// lab8-2</span>
<span class="token comment">//  // Create linked list of buffers</span>
<span class="token comment">//  bcache.head.prev = &amp;bcache.head;</span>
<span class="token comment">//  bcache.head.next = &amp;bcache.head;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>b <span class="token operator">=</span> bcache<span class="token punctuation">.</span>buf<span class="token punctuation">;</span> b <span class="token operator">&lt;</span> bcache<span class="token punctuation">.</span>buf<span class="token operator">+</span>NBUF<span class="token punctuation">;</span> b<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token comment">// lab8-2</span>
<span class="token comment">//    b-&gt;next = bcache.head.next;</span>
<span class="token comment">//    b-&gt;prev = &amp;bcache.head;</span>
    <span class="token function">initsleeplock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-&gt;</span>lock<span class="token punctuation">,</span> <span class="token string">&quot;buffer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//    bcache.head.next-&gt;prev = b;</span>
<span class="token comment">//    bcache.head.next = b;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div></li> <li><p>修改 kernel/bio.c 中的 brelse() 函数.
该函数用于释放缓存块. 在原本的实现中, 若其引用计数为 0, 则将其移至双向链表表头, 这样双向链表表头是最近使用的, 表尾是最近未使用的, 构成一个 LRU 序列, 方便 bget() 函数寻找缓存块.
而此处要使用基于时间戳的 LRU 实现, 因此不再使用双向链表, 只需要将当前的时间戳记录的缓存块的 timestamp 字段.
此外, 由于是通过哈希表管理, 加锁也由原本的全局锁改为缓存块所在的 bucket 的锁.</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">extern</span> uint ticks<span class="token punctuation">;</span>  

<span class="token keyword">void</span>
<span class="token function">brelse</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>b<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> idx<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">holdingsleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;brelse&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">releasesleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// change the lock - lab8-2</span>
  idx <span class="token operator">=</span> <span class="token function">HASH</span><span class="token punctuation">(</span>b<span class="token operator">-&gt;</span>blockno<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>locks<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  b<span class="token operator">-&gt;</span>refcnt<span class="token operator">--</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">-&gt;</span>refcnt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// no one is waiting for it.</span>
<span class="token comment">// lab8-2</span>
<span class="token comment">//    b-&gt;next-&gt;prev = b-&gt;prev;</span>
<span class="token comment">//    b-&gt;prev-&gt;next = b-&gt;next;</span>
<span class="token comment">//    b-&gt;next = bcache.head.next;</span>
<span class="token comment">//    b-&gt;prev = &amp;bcache.head;</span>
<span class="token comment">//    bcache.head.next-&gt;prev = b;</span>
<span class="token comment">//    bcache.head.next = b;</span>
    b<span class="token operator">-&gt;</span>timestamp <span class="token operator">=</span> ticks<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>locks<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div></li> <li><p>修改 <code>kernel/bio.c</code> 中的 <code>bpin()</code> 和 <code>bunpin()</code> 函数.
这两个函数的修改比较简单, 就是将原本的全局锁替换为缓存块对应的 bucket 的锁即可.</p></li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span>
<span class="token function">bpin</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token function">HASH</span><span class="token punctuation">(</span>b<span class="token operator">-&gt;</span>blockno<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>locks<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  b<span class="token operator">-&gt;</span>refcnt<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>locks<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span>
<span class="token function">bunpin</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token function">HASH</span><span class="token punctuation">(</span>b<span class="token operator">-&gt;</span>blockno<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>locks<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  b<span class="token operator">-&gt;</span>refcnt<span class="token operator">--</span><span class="token punctuation">;</span>
  <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>locks<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li> <li><p>修改 <code>bget()</code> 函数</p> <ol><li><p>首先是根据 <code>blockno</code> 在哈希表相应 bucket 的链表中寻找对应的缓存块, 如果找到则直接返回. 这里找到的条件以及相应的操作和原实现在双向链表中查找是一致的.</p></li> <li><p>若未在哈希表 bucket 中找到, 则先考虑进行缓存块的分配. 和原实现中所有缓存块初始化插入双向链表中不同, 此处哈希表最初是空的, 根据 bcache.size 字段可以得知当前已经分配的缓存块, 只要还有缓存块未分配, 则进行分配, 进行缓存块的初始化操作后, 再将缓存块插入到对应的哈希表 bucket 中</p></li> <li><p>最后若缓存块已经全部分配出去了, 则根据时间戳找寻缓存块进行重用.  对哈希表的每个 bucket 进行依次的寻找, 先从目标的 bucket (即 <code>idx=HASH(blockno)</code>)开始, <strong>遍历整个 bucket 的链表, 找到引用计数为 0 且时间戳最小的缓存块进行重用</strong>.</p></li> <li><p>对整个过程中加锁的考虑 (hard)</p></li></ol> <p>在步骤 1 中, 很显然由于需要遍历哈希表的 bucket, 只需要对这个 bucket 加锁 locks[idx].
而在步骤 2 中, 由于会对 size 字段进行读取和更新, 因此需要在其前后加锁 lock. 这里有一个问题就是此时是否需要释放 locks[idx] 锁, 答案是否定的, 因为一旦释放, 则可能有另一个线程对同一缓存块进行访问, 而此时第一个线程可能还正在分配, 缓存块还未更新到 bucket 链表中, 由于 bucket 的锁已经释放, 这样第二个线程可以遍历该 bucket 链表, 同样发现缓存块不存在则去申请分配. 从而导致同一块会被多次分配, 这样是不允许的, 因此需要在申请分配时一直持有 locks[idx] 锁, 这样其他线程在申请缓存块的过程中是无法访问目标 bucket 的, 便避免了上述问题. 当然, 在 size 字段更新后就可以释放 lock 锁了, 这是没有问题的, 这样其他 bucket 可以再去申请新的缓存块.
而在步骤 3 寻找可重用缓存块时加锁就更为复杂. 容易分析得到的是, 这个过程可能会遍历多个 bucket, 因此每次循环需要对当前 bucket 进行加锁和解锁. 而这里有一个问题, 一旦释放了当前目标 bucket(idx=HASH(blockno))的锁, 则就可以有另一个线程同样去访问该缓存块, 致使同样走到步骤 3 尝试找可重用块, 显然这样可能导致可重用块覆盖的问题, 因此此时需要哈希表全局锁 hashlock 在步骤 3 前进行加锁, 以保证只能有 1 个线程能够寻找可重用块. 此时需要注意的是, 由于步骤 3 开始前一直持有锁 locks[idx], 需要先进行释放, 而释放后如前文所述可能会有另一个线程走到步骤 3, 此时由于获取不到 hashlock 会被阻塞, 但当第一个线程找到重用块后, 该线程会获取到 hashlock, 但此时不应该继续找重用块, 而是要同步骤 1 一样遍历链表判读是否此时已经有了目标缓存块了.
最后说明一下为什么 hashlock 和 lock 需要是两个不同的锁. 首先 lock 锁用于保证 size 字段的线程安全, 而且在步骤 2 时, 会在获取 locks[idx] 锁后尝试获取 lock. 而在步骤 3 之前需要先释放 locks[idx] 锁, 而在持有哈希表的全局锁 hashlock 后再重新尝试获取 locks[idx]. 很显然, 若一个线程在步骤 3 持有 hashlock 尝试获取 locks[idx], 另一个线程在步骤 2 持有 locks[idx] 尝试获取 lock, 若二者是同一个锁就会造成死锁. 因此, 需要两个锁.</p></li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">buf</span><span class="token operator">*</span>
<span class="token function">bget</span><span class="token punctuation">(</span>uint dev<span class="token punctuation">,</span> uint blockno<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>b<span class="token punctuation">;</span>
  <span class="token comment">// lab8-2</span>
  <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token function">HASH</span><span class="token punctuation">(</span>blockno<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>pre<span class="token punctuation">,</span> <span class="token operator">*</span>minb <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">*</span>minpre<span class="token punctuation">;</span>
  uint mintimestamp<span class="token punctuation">;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>
  
  <span class="token comment">// loop up the buf in the buckets[idx]</span>
  <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>locks<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// lab8-2</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>b <span class="token operator">=</span> bcache<span class="token punctuation">.</span>buckets<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>next<span class="token punctuation">;</span> b<span class="token punctuation">;</span> b <span class="token operator">=</span> b<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>b<span class="token operator">-&gt;</span>dev <span class="token operator">==</span> dev <span class="token operator">&amp;&amp;</span> b<span class="token operator">-&gt;</span>blockno <span class="token operator">==</span> blockno<span class="token punctuation">)</span><span class="token punctuation">{</span>
      b<span class="token operator">-&gt;</span>refcnt<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>locks<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// lab8-2</span>
      <span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Not cached.</span>
  <span class="token comment">// check if there is a buf not used -lab8-2</span>
  <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>bcache<span class="token punctuation">.</span>size <span class="token operator">&lt;</span> NBUF<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    b <span class="token operator">=</span> <span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>buf<span class="token punctuation">[</span>bcache<span class="token punctuation">.</span>size<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    b<span class="token operator">-&gt;</span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
    b<span class="token operator">-&gt;</span>blockno <span class="token operator">=</span> blockno<span class="token punctuation">;</span>
    b<span class="token operator">-&gt;</span>valid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    b<span class="token operator">-&gt;</span>refcnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    b<span class="token operator">-&gt;</span>next <span class="token operator">=</span> bcache<span class="token punctuation">.</span>buckets<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    bcache<span class="token punctuation">.</span>buckets<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>next <span class="token operator">=</span> b<span class="token punctuation">;</span>
    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>locks<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> b<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>locks<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// select the last-recently used block int the bucket</span>
  <span class="token comment">//based on the timestamp - lab8-2</span>
  <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>hashlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NBUCKET<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mintimestamp <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>locks<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span>pre <span class="token operator">=</span> <span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>buckets<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> b <span class="token operator">=</span> pre<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span> b<span class="token punctuation">;</span> pre <span class="token operator">=</span> b<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// research the block</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>idx <span class="token operator">==</span> <span class="token function">HASH</span><span class="token punctuation">(</span>blockno<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> b<span class="token operator">-&gt;</span>dev <span class="token operator">==</span> dev <span class="token operator">&amp;&amp;</span> b<span class="token operator">-&gt;</span>blockno <span class="token operator">==</span> blockno<span class="token punctuation">)</span><span class="token punctuation">{</span>
              b<span class="token operator">-&gt;</span>refcnt<span class="token operator">++</span><span class="token punctuation">;</span>
              <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>locks<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>hashlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> b<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>b<span class="token operator">-&gt;</span>refcnt <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> b<span class="token operator">-&gt;</span>timestamp <span class="token operator">&lt;</span> mintimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              minb <span class="token operator">=</span> b<span class="token punctuation">;</span>
              minpre <span class="token operator">=</span> pre<span class="token punctuation">;</span>
              mintimestamp <span class="token operator">=</span> b<span class="token operator">-&gt;</span>timestamp<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// find an unused block</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>minb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          minb<span class="token operator">-&gt;</span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
          minb<span class="token operator">-&gt;</span>blockno <span class="token operator">=</span> blockno<span class="token punctuation">;</span>
          minb<span class="token operator">-&gt;</span>valid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          minb<span class="token operator">-&gt;</span>refcnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
          <span class="token comment">// if block in another bucket, we should move it to correct bucket</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>idx <span class="token operator">!=</span> <span class="token function">HASH</span><span class="token punctuation">(</span>blockno<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              minpre<span class="token operator">-&gt;</span>next <span class="token operator">=</span> minb<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>    <span class="token comment">// remove block</span>
              <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>locks<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              idx <span class="token operator">=</span> <span class="token function">HASH</span><span class="token punctuation">(</span>blockno<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// the correct bucket index</span>
              <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>locks<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              minb<span class="token operator">-&gt;</span>next <span class="token operator">=</span> bcache<span class="token punctuation">.</span>buckets<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>next<span class="token punctuation">;</span>    <span class="token comment">// move block to correct bucket</span>
              bcache<span class="token punctuation">.</span>buckets<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>next <span class="token operator">=</span> minb<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>locks<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>hashlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>minb<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> minb<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcache<span class="token punctuation">.</span>locks<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">++</span>idx <span class="token operator">==</span> NBUCKET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token comment">// lab8-2</span>
<span class="token comment">//  // Recycle the least recently used (LRU) unused buffer.</span>
<span class="token comment">//  for(b = bcache.head.prev; b != &amp;bcache.head; b = b-&gt;prev){</span>
<span class="token comment">//    if(b-&gt;refcnt == 0) {</span>
<span class="token comment">//      b-&gt;dev = dev;</span>
<span class="token comment">//      b-&gt;blockno = blockno;</span>
<span class="token comment">//      b-&gt;valid = 0;</span>
<span class="token comment">//      b-&gt;refcnt = 1;</span>
<span class="token comment">//      release(&amp;bcache.lock);</span>
<span class="token comment">//      acquiresleep(&amp;b-&gt;lock);</span>
<span class="token comment">//      return b;</span>
<span class="token comment">//    }</span>
<span class="token comment">//  }</span>
  <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;bget: no buffers&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br></div></div><h3 id="结果-2"><a href="#结果-2" class="header-anchor">#</a> 结果</h3> <ul><li>在 xv6 中运行 bcachetest, 输出如下, 可以看到 bcache 相关锁的争用情况大幅下降, acquire() 整体次数大幅减少, 最多被调用了 8500 次左右, 比修改前次数减少了一半多, 且自旋尝试获取锁的次数均为 0 次. 同时 bcache 中的锁也不再是最具争用性的 5 个锁. 测试 test0 和 test1 也均通过.</li></ul> <p><img src="https://img-blog.csdnimg.cn/1fd2cd034a564fe2b3ea54780d710d48.png" alt="在这里插入图片描述"></p> <p><img src="https://img-blog.csdnimg.cn/481836c80caa4da68ea80248fbddad69.png" alt="在这里插入图片描述"></p> <ul><li>在 xv6 中执行 <code>usertests</code> 测试 和 执行make grade测试</li></ul> <p><img src="https://img-blog.csdnimg.cn/de869fee88bf43538c42ff82ce6ead85.png" alt="在这里插入图片描述"></p> <p><img src="https://img-blog.csdnimg.cn/c4ef26caff374e4b8b5a898da07142fc.png" alt="在这里插入图片描述"></p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2022/9/30 下午1:13:50</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/项目/MIT6.s081/lab7 Multithreading.html" class="prev">
          操作系统lab7 Multithreading
        </a></span> <span class="next"><a href="/项目/MIT6.s081/lab9 file system.html">
          操作系统lab9 file system
        </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-2c0089e8><li class="level-2" data-v-2c0089e8><a href="/%E9%A1%B9%E7%9B%AE/MIT6.s081/lab8%20locks.html#一、memory-allocator" class="sidebar-link reco-side-一、memory-allocator" data-v-2c0089e8>一、Memory allocator</a></li><li class="level-3" data-v-2c0089e8><a href="/%E9%A1%B9%E7%9B%AE/MIT6.s081/lab8%20locks.html#预处理" class="sidebar-link reco-side-预处理" data-v-2c0089e8>预处理</a></li><li class="level-3" data-v-2c0089e8><a href="/%E9%A1%B9%E7%9B%AE/MIT6.s081/lab8%20locks.html#要点" class="sidebar-link reco-side-要点" data-v-2c0089e8>要点</a></li><li class="level-3" data-v-2c0089e8><a href="/%E9%A1%B9%E7%9B%AE/MIT6.s081/lab8%20locks.html#步骤" class="sidebar-link reco-side-步骤" data-v-2c0089e8>步骤</a></li><li class="level-3" data-v-2c0089e8><a href="/%E9%A1%B9%E7%9B%AE/MIT6.s081/lab8%20locks.html#结果" class="sidebar-link reco-side-结果" data-v-2c0089e8>结果</a></li><li class="level-2" data-v-2c0089e8><a href="/%E9%A1%B9%E7%9B%AE/MIT6.s081/lab8%20locks.html#二、buffer-cache" class="sidebar-link reco-side-二、buffer-cache" data-v-2c0089e8>二、Buffer cache</a></li><li class="level-3" data-v-2c0089e8><a href="/%E9%A1%B9%E7%9B%AE/MIT6.s081/lab8%20locks.html#预处理-2" class="sidebar-link reco-side-预处理-2" data-v-2c0089e8>预处理</a></li><li class="level-3" data-v-2c0089e8><a href="/%E9%A1%B9%E7%9B%AE/MIT6.s081/lab8%20locks.html#要点-2" class="sidebar-link reco-side-要点-2" data-v-2c0089e8>要点</a></li><li class="level-3" data-v-2c0089e8><a href="/%E9%A1%B9%E7%9B%AE/MIT6.s081/lab8%20locks.html#思路" class="sidebar-link reco-side-思路" data-v-2c0089e8>思路</a></li><li class="level-3" data-v-2c0089e8><a href="/%E9%A1%B9%E7%9B%AE/MIT6.s081/lab8%20locks.html#步骤-2" class="sidebar-link reco-side-步骤-2" data-v-2c0089e8>步骤</a></li><li class="level-3" data-v-2c0089e8><a href="/%E9%A1%B9%E7%9B%AE/MIT6.s081/lab8%20locks.html#结果-2" class="sidebar-link reco-side-结果-2" data-v-2c0089e8>结果</a></li></ul></main></div> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="Sakura" data-v-248d85d6><canvas id="canvas_sakura" style="z-index:-1;" data-v-248d85d6></canvas></div><canvas id="vuepress-canvas-cursor"></canvas><!----></div></div>
    <script src="/assets/js/app.bb08115f.js" defer></script><script src="/assets/js/3.583d0c72.js" defer></script><script src="/assets/js/1.eb42dbb0.js" defer></script><script src="/assets/js/282.60ce8d90.js" defer></script>
  </body>
</html>
