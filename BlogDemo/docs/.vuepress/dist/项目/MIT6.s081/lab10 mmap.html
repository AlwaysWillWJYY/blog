<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>操作系统lab10 mmap | Auraro&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/logo.png">
    <script language="javascript" type="text/javascript" src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="/js/MouseClickEffect.js"></script>
    <meta name="description" content="面向对象面向君，不负代码不负卿。">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="keywords" content="AuraroJ,博客,conimi,nico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/assets/css/0.styles.f7a51907.css" as="style"><link rel="preload" href="/assets/js/app.bb08115f.js" as="script"><link rel="preload" href="/assets/js/3.583d0c72.js" as="script"><link rel="preload" href="/assets/js/1.eb42dbb0.js" as="script"><link rel="preload" href="/assets/js/275.20c3ffb2.js" as="script"><link rel="prefetch" href="/assets/js/10.5cde4a25.js"><link rel="prefetch" href="/assets/js/100.75d8cc25.js"><link rel="prefetch" href="/assets/js/101.07aef68f.js"><link rel="prefetch" href="/assets/js/102.6be744c5.js"><link rel="prefetch" href="/assets/js/103.023b2c9f.js"><link rel="prefetch" href="/assets/js/104.cce0b172.js"><link rel="prefetch" href="/assets/js/105.c68ec71c.js"><link rel="prefetch" href="/assets/js/106.d8cd02e9.js"><link rel="prefetch" href="/assets/js/107.10ab63dc.js"><link rel="prefetch" href="/assets/js/108.c194d7a0.js"><link rel="prefetch" href="/assets/js/109.2ce7e1ec.js"><link rel="prefetch" href="/assets/js/11.00989c85.js"><link rel="prefetch" href="/assets/js/110.88e49ffa.js"><link rel="prefetch" href="/assets/js/111.83497f18.js"><link rel="prefetch" href="/assets/js/112.f0ab65da.js"><link rel="prefetch" href="/assets/js/113.1d693a7a.js"><link rel="prefetch" href="/assets/js/114.4c0138cc.js"><link rel="prefetch" href="/assets/js/115.a9b632ba.js"><link rel="prefetch" href="/assets/js/116.7b278849.js"><link rel="prefetch" href="/assets/js/117.d551d77f.js"><link rel="prefetch" href="/assets/js/118.446c75f9.js"><link rel="prefetch" href="/assets/js/119.159faacb.js"><link rel="prefetch" href="/assets/js/12.089cc736.js"><link rel="prefetch" href="/assets/js/120.993eb659.js"><link rel="prefetch" href="/assets/js/121.91eabb47.js"><link rel="prefetch" href="/assets/js/122.5dd0e20b.js"><link rel="prefetch" href="/assets/js/123.bf8487e0.js"><link rel="prefetch" href="/assets/js/124.ef736623.js"><link rel="prefetch" href="/assets/js/125.3551f34f.js"><link rel="prefetch" href="/assets/js/126.22f20917.js"><link rel="prefetch" href="/assets/js/127.70b4085f.js"><link rel="prefetch" href="/assets/js/128.fce6d6c1.js"><link rel="prefetch" href="/assets/js/129.eebeeeab.js"><link rel="prefetch" href="/assets/js/13.d19e71e7.js"><link rel="prefetch" href="/assets/js/130.85411c7a.js"><link rel="prefetch" href="/assets/js/131.3fca59eb.js"><link rel="prefetch" href="/assets/js/132.25b456b1.js"><link rel="prefetch" href="/assets/js/133.ec7f2575.js"><link rel="prefetch" href="/assets/js/134.6eb7d7b9.js"><link rel="prefetch" href="/assets/js/135.af6d168b.js"><link rel="prefetch" href="/assets/js/136.8be0a8ae.js"><link rel="prefetch" href="/assets/js/137.77d58955.js"><link rel="prefetch" href="/assets/js/138.b8831210.js"><link rel="prefetch" href="/assets/js/139.cb137b06.js"><link rel="prefetch" href="/assets/js/14.add2b9d1.js"><link rel="prefetch" href="/assets/js/140.ce022ddc.js"><link rel="prefetch" href="/assets/js/141.eb1ca496.js"><link rel="prefetch" href="/assets/js/142.7b71b730.js"><link rel="prefetch" href="/assets/js/143.bd7e5c17.js"><link rel="prefetch" href="/assets/js/144.dd4a340f.js"><link rel="prefetch" href="/assets/js/145.88dc409a.js"><link rel="prefetch" href="/assets/js/146.587cf339.js"><link rel="prefetch" href="/assets/js/147.0c6cb42f.js"><link rel="prefetch" href="/assets/js/148.cde21382.js"><link rel="prefetch" href="/assets/js/149.57eb32ce.js"><link rel="prefetch" href="/assets/js/15.a7aa72c2.js"><link rel="prefetch" href="/assets/js/150.13c70aa7.js"><link rel="prefetch" href="/assets/js/151.860bec6e.js"><link rel="prefetch" href="/assets/js/152.a773d846.js"><link rel="prefetch" href="/assets/js/153.b79da999.js"><link rel="prefetch" href="/assets/js/154.90f51676.js"><link rel="prefetch" href="/assets/js/155.85fc9cca.js"><link rel="prefetch" href="/assets/js/156.55b47274.js"><link rel="prefetch" href="/assets/js/157.7efb004d.js"><link rel="prefetch" href="/assets/js/158.0da04a2c.js"><link rel="prefetch" href="/assets/js/159.846f8392.js"><link rel="prefetch" href="/assets/js/16.1ca91cef.js"><link rel="prefetch" href="/assets/js/160.1162f9b8.js"><link rel="prefetch" href="/assets/js/161.daace554.js"><link rel="prefetch" href="/assets/js/162.c76db0ce.js"><link rel="prefetch" href="/assets/js/163.2922410c.js"><link rel="prefetch" href="/assets/js/164.d8677450.js"><link rel="prefetch" href="/assets/js/165.c1cd35cf.js"><link rel="prefetch" href="/assets/js/166.34353f65.js"><link rel="prefetch" href="/assets/js/167.53b5f90d.js"><link rel="prefetch" href="/assets/js/168.d1372efa.js"><link rel="prefetch" href="/assets/js/169.44b88d34.js"><link rel="prefetch" href="/assets/js/17.bfc3e676.js"><link rel="prefetch" href="/assets/js/170.2b7c10df.js"><link rel="prefetch" href="/assets/js/171.5d9bfbf8.js"><link rel="prefetch" href="/assets/js/172.83f4beda.js"><link rel="prefetch" href="/assets/js/173.672f9679.js"><link rel="prefetch" href="/assets/js/174.854c72cd.js"><link rel="prefetch" href="/assets/js/175.4bb04152.js"><link rel="prefetch" href="/assets/js/176.3cf0876d.js"><link rel="prefetch" href="/assets/js/177.479a4ce4.js"><link rel="prefetch" href="/assets/js/178.f4236b6b.js"><link rel="prefetch" href="/assets/js/179.0ffac3fc.js"><link rel="prefetch" href="/assets/js/18.a7ccbc8f.js"><link rel="prefetch" href="/assets/js/180.0349746e.js"><link rel="prefetch" href="/assets/js/181.b382b91a.js"><link rel="prefetch" href="/assets/js/182.45ea1be0.js"><link rel="prefetch" href="/assets/js/183.d97ff0f2.js"><link rel="prefetch" href="/assets/js/184.04db3fa2.js"><link rel="prefetch" href="/assets/js/185.06886175.js"><link rel="prefetch" href="/assets/js/186.1e507894.js"><link rel="prefetch" href="/assets/js/187.2d443b36.js"><link rel="prefetch" href="/assets/js/188.47ac887d.js"><link rel="prefetch" href="/assets/js/189.588ea60e.js"><link rel="prefetch" href="/assets/js/19.fb710d2b.js"><link rel="prefetch" href="/assets/js/190.427f20ae.js"><link rel="prefetch" href="/assets/js/191.74e4417a.js"><link rel="prefetch" href="/assets/js/192.ecd17749.js"><link rel="prefetch" href="/assets/js/193.34698712.js"><link rel="prefetch" href="/assets/js/194.3af39153.js"><link rel="prefetch" href="/assets/js/195.e2d999ff.js"><link rel="prefetch" href="/assets/js/196.2585faf4.js"><link rel="prefetch" href="/assets/js/197.1b4f726d.js"><link rel="prefetch" href="/assets/js/198.78a41910.js"><link rel="prefetch" href="/assets/js/199.13fc9f5f.js"><link rel="prefetch" href="/assets/js/20.9b50ffb2.js"><link rel="prefetch" href="/assets/js/200.704d8809.js"><link rel="prefetch" href="/assets/js/201.4e7b7c78.js"><link rel="prefetch" href="/assets/js/202.5b83bc37.js"><link rel="prefetch" href="/assets/js/203.20cafd87.js"><link rel="prefetch" href="/assets/js/204.e13a329c.js"><link rel="prefetch" href="/assets/js/205.70cbfd9d.js"><link rel="prefetch" href="/assets/js/206.b24a6498.js"><link rel="prefetch" href="/assets/js/207.c1f54a7b.js"><link rel="prefetch" href="/assets/js/208.b42ff2a7.js"><link rel="prefetch" href="/assets/js/209.025d3bc5.js"><link rel="prefetch" href="/assets/js/21.7fc2c3c0.js"><link rel="prefetch" href="/assets/js/210.fdac89cc.js"><link rel="prefetch" href="/assets/js/211.856ce748.js"><link rel="prefetch" href="/assets/js/212.b3203755.js"><link rel="prefetch" href="/assets/js/213.6573a28e.js"><link rel="prefetch" href="/assets/js/214.2134f64a.js"><link rel="prefetch" href="/assets/js/215.083a9e85.js"><link rel="prefetch" href="/assets/js/216.57a091f2.js"><link rel="prefetch" href="/assets/js/217.cfad87ef.js"><link rel="prefetch" href="/assets/js/218.d84ebfbf.js"><link rel="prefetch" href="/assets/js/219.839d2285.js"><link rel="prefetch" href="/assets/js/22.715a7176.js"><link rel="prefetch" href="/assets/js/220.d12122eb.js"><link rel="prefetch" href="/assets/js/221.2bbdc524.js"><link rel="prefetch" href="/assets/js/222.ffb4c7db.js"><link rel="prefetch" href="/assets/js/223.d6779006.js"><link rel="prefetch" href="/assets/js/224.ca7b9a36.js"><link rel="prefetch" href="/assets/js/225.65f7cf7a.js"><link rel="prefetch" href="/assets/js/226.2f8fc6e2.js"><link rel="prefetch" href="/assets/js/227.a3ee9541.js"><link rel="prefetch" href="/assets/js/228.fa88d7b3.js"><link rel="prefetch" href="/assets/js/229.d2287ac3.js"><link rel="prefetch" href="/assets/js/23.7cc08dae.js"><link rel="prefetch" href="/assets/js/230.78a12551.js"><link rel="prefetch" href="/assets/js/231.29c15b3f.js"><link rel="prefetch" href="/assets/js/232.4d55e308.js"><link rel="prefetch" href="/assets/js/233.fe9f330b.js"><link rel="prefetch" href="/assets/js/234.3cd7f9e8.js"><link rel="prefetch" href="/assets/js/235.88874d60.js"><link rel="prefetch" href="/assets/js/236.d30e0441.js"><link rel="prefetch" href="/assets/js/237.5bceaca4.js"><link rel="prefetch" href="/assets/js/238.d72d8310.js"><link rel="prefetch" href="/assets/js/239.7610035e.js"><link rel="prefetch" href="/assets/js/24.039ee5f1.js"><link rel="prefetch" href="/assets/js/240.12b18259.js"><link rel="prefetch" href="/assets/js/241.e3d28483.js"><link rel="prefetch" href="/assets/js/242.3f37dd43.js"><link rel="prefetch" href="/assets/js/243.ada242d5.js"><link rel="prefetch" href="/assets/js/244.77d0d090.js"><link rel="prefetch" href="/assets/js/245.1c5cb9be.js"><link rel="prefetch" href="/assets/js/246.8d72f493.js"><link rel="prefetch" href="/assets/js/247.00962acf.js"><link rel="prefetch" href="/assets/js/248.f8f7aaf9.js"><link rel="prefetch" href="/assets/js/249.980b6ec6.js"><link rel="prefetch" href="/assets/js/25.dec20d17.js"><link rel="prefetch" href="/assets/js/250.c61aee6f.js"><link rel="prefetch" href="/assets/js/251.f096bb18.js"><link rel="prefetch" href="/assets/js/252.0663ea3d.js"><link rel="prefetch" href="/assets/js/253.be02497e.js"><link rel="prefetch" href="/assets/js/254.7af2d67c.js"><link rel="prefetch" href="/assets/js/255.7c4ba5e4.js"><link rel="prefetch" href="/assets/js/256.99a3a5a3.js"><link rel="prefetch" href="/assets/js/257.496e55b4.js"><link rel="prefetch" href="/assets/js/258.0e780483.js"><link rel="prefetch" href="/assets/js/259.5e859f0e.js"><link rel="prefetch" href="/assets/js/26.aad5fbf0.js"><link rel="prefetch" href="/assets/js/260.301554ac.js"><link rel="prefetch" href="/assets/js/261.80b7eca1.js"><link rel="prefetch" href="/assets/js/262.eaaba93a.js"><link rel="prefetch" href="/assets/js/263.af5b179f.js"><link rel="prefetch" href="/assets/js/264.219ac8df.js"><link rel="prefetch" href="/assets/js/265.7ec04094.js"><link rel="prefetch" href="/assets/js/266.8c34db6a.js"><link rel="prefetch" href="/assets/js/267.db88eae1.js"><link rel="prefetch" href="/assets/js/268.fccf8b81.js"><link rel="prefetch" href="/assets/js/269.7edf2854.js"><link rel="prefetch" href="/assets/js/27.0d3eeb1c.js"><link rel="prefetch" href="/assets/js/270.27ba6bda.js"><link rel="prefetch" href="/assets/js/271.b52774aa.js"><link rel="prefetch" href="/assets/js/272.63c82e0b.js"><link rel="prefetch" href="/assets/js/273.2b2b816a.js"><link rel="prefetch" href="/assets/js/274.1420285e.js"><link rel="prefetch" href="/assets/js/276.ba2ba72d.js"><link rel="prefetch" href="/assets/js/277.ca678acc.js"><link rel="prefetch" href="/assets/js/278.b76a2675.js"><link rel="prefetch" href="/assets/js/279.32c5b1ab.js"><link rel="prefetch" href="/assets/js/28.037ed440.js"><link rel="prefetch" href="/assets/js/280.ee764623.js"><link rel="prefetch" href="/assets/js/281.296dd9d9.js"><link rel="prefetch" href="/assets/js/282.60ce8d90.js"><link rel="prefetch" href="/assets/js/283.2a5b9e15.js"><link rel="prefetch" href="/assets/js/284.6b7af45b.js"><link rel="prefetch" href="/assets/js/285.415ab5cd.js"><link rel="prefetch" href="/assets/js/286.bc0040ae.js"><link rel="prefetch" href="/assets/js/29.e52a9d90.js"><link rel="prefetch" href="/assets/js/30.5236c1bc.js"><link rel="prefetch" href="/assets/js/31.47ca8aab.js"><link rel="prefetch" href="/assets/js/32.a7a02a99.js"><link rel="prefetch" href="/assets/js/33.65976515.js"><link rel="prefetch" href="/assets/js/34.2da58a6a.js"><link rel="prefetch" href="/assets/js/35.5284e75e.js"><link rel="prefetch" href="/assets/js/36.446ea69b.js"><link rel="prefetch" href="/assets/js/37.6170733e.js"><link rel="prefetch" href="/assets/js/38.4e800202.js"><link rel="prefetch" href="/assets/js/39.1729ae1c.js"><link rel="prefetch" href="/assets/js/4.10543b34.js"><link rel="prefetch" href="/assets/js/40.f6d02ad2.js"><link rel="prefetch" href="/assets/js/41.bb74528d.js"><link rel="prefetch" href="/assets/js/42.06cea1eb.js"><link rel="prefetch" href="/assets/js/43.77b26dc8.js"><link rel="prefetch" href="/assets/js/44.15101d20.js"><link rel="prefetch" href="/assets/js/45.1f3d695e.js"><link rel="prefetch" href="/assets/js/46.3396517f.js"><link rel="prefetch" href="/assets/js/47.aaa8a50e.js"><link rel="prefetch" href="/assets/js/48.a1986c37.js"><link rel="prefetch" href="/assets/js/49.db5b026a.js"><link rel="prefetch" href="/assets/js/5.d0f450bd.js"><link rel="prefetch" href="/assets/js/50.40ac975f.js"><link rel="prefetch" href="/assets/js/51.c36c9269.js"><link rel="prefetch" href="/assets/js/52.40d65fd0.js"><link rel="prefetch" href="/assets/js/53.c165027a.js"><link rel="prefetch" href="/assets/js/54.6568d816.js"><link rel="prefetch" href="/assets/js/55.b22b5348.js"><link rel="prefetch" href="/assets/js/56.c8d66f18.js"><link rel="prefetch" href="/assets/js/57.2360da04.js"><link rel="prefetch" href="/assets/js/58.002a9b2f.js"><link rel="prefetch" href="/assets/js/59.80ea1446.js"><link rel="prefetch" href="/assets/js/6.24060e60.js"><link rel="prefetch" href="/assets/js/60.2ffa491c.js"><link rel="prefetch" href="/assets/js/61.d1ba9295.js"><link rel="prefetch" href="/assets/js/62.77818eb4.js"><link rel="prefetch" href="/assets/js/63.37359d58.js"><link rel="prefetch" href="/assets/js/64.8815086a.js"><link rel="prefetch" href="/assets/js/65.7a939c94.js"><link rel="prefetch" href="/assets/js/66.e49d453d.js"><link rel="prefetch" href="/assets/js/67.6aceb9b9.js"><link rel="prefetch" href="/assets/js/68.98753229.js"><link rel="prefetch" href="/assets/js/69.07dfa16b.js"><link rel="prefetch" href="/assets/js/7.b8bf6b3f.js"><link rel="prefetch" href="/assets/js/70.9da04b45.js"><link rel="prefetch" href="/assets/js/71.59a42831.js"><link rel="prefetch" href="/assets/js/72.7d4af0fa.js"><link rel="prefetch" href="/assets/js/73.c0481ff8.js"><link rel="prefetch" href="/assets/js/74.3c19f028.js"><link rel="prefetch" href="/assets/js/75.eb0b4a24.js"><link rel="prefetch" href="/assets/js/76.32002664.js"><link rel="prefetch" href="/assets/js/77.6146716f.js"><link rel="prefetch" href="/assets/js/78.d7fc6256.js"><link rel="prefetch" href="/assets/js/79.841f0d44.js"><link rel="prefetch" href="/assets/js/8.024a3703.js"><link rel="prefetch" href="/assets/js/80.04f40382.js"><link rel="prefetch" href="/assets/js/81.baf9eaf4.js"><link rel="prefetch" href="/assets/js/82.82e2cd4b.js"><link rel="prefetch" href="/assets/js/83.508e9bc6.js"><link rel="prefetch" href="/assets/js/84.ff8f727a.js"><link rel="prefetch" href="/assets/js/85.b88ebfaf.js"><link rel="prefetch" href="/assets/js/86.68de79a4.js"><link rel="prefetch" href="/assets/js/87.4f2ac4cc.js"><link rel="prefetch" href="/assets/js/88.221a9d92.js"><link rel="prefetch" href="/assets/js/89.e2928c4d.js"><link rel="prefetch" href="/assets/js/9.d630a5e2.js"><link rel="prefetch" href="/assets/js/90.09bb8952.js"><link rel="prefetch" href="/assets/js/91.27f5fda2.js"><link rel="prefetch" href="/assets/js/92.a9fb67dd.js"><link rel="prefetch" href="/assets/js/93.5bd59d9e.js"><link rel="prefetch" href="/assets/js/94.ff1cee5f.js"><link rel="prefetch" href="/assets/js/95.2d7759a8.js"><link rel="prefetch" href="/assets/js/96.5b1279d7.js"><link rel="prefetch" href="/assets/js/97.c4efd893.js"><link rel="prefetch" href="/assets/js/98.a49b59f7.js"><link rel="prefetch" href="/assets/js/99.1653d757.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f7a51907.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-11f94078><div data-v-11f94078><div class="password-shadow password-wrapper-out" style="display:none;" data-v-08f61db9 data-v-11f94078 data-v-11f94078><h3 class="title" data-v-08f61db9>Auraro's Blog</h3> <p class="description" data-v-08f61db9>面向对象面向君，不负代码不负卿。</p> <label id="box" class="inputBox" data-v-08f61db9><input type="password" value="" data-v-08f61db9> <span data-v-08f61db9>Konck! Knock!</span> <button data-v-08f61db9>OK</button></label> <div class="footer" data-v-08f61db9><span data-v-08f61db9><i class="iconfont reco-theme" data-v-08f61db9></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-08f61db9>vuePress-theme-reco</a></span> <span data-v-08f61db9><i class="iconfont reco-copyright" data-v-08f61db9></i> <a data-v-08f61db9><span data-v-08f61db9>AuraroJ</span>
          
        <!---->
        2022
      </a></span></div></div> <div class="hide" data-v-11f94078><header class="navbar" data-v-11f94078><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Auraro's Blog" class="logo"> <span class="site-name">Auraro's Blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  随性一点的主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/随笔/me.html" class="nav-link"><i class="undefined"></i>
  随笔
</a></li><li class="dropdown-item"><!----> <a href="/面经/" class="nav-link"><i class="undefined"></i>
  面经
</a></li><li class="dropdown-item"><!----> <a href="/network/浏览器输入url过程.html" class="nav-link"><i class="undefined"></i>
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/Os/段式存储和页式存储.html" class="nav-link"><i class="undefined"></i>
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/中间件/" class="nav-link"><i class="undefined"></i>
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/Java-框架/" class="nav-link"><i class="undefined"></i>
  Java框架
</a></li><li class="dropdown-item"><!----> <a href="/Linux/常见面试题.html" class="nav-link"><i class="undefined"></i>
  Linux
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  随笔标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      项目
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>底层项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.830 JAVA
</a></li><li class="dropdown-subitem"><a href="/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.s081 C
</a></li><li class="dropdown-subitem"><a href="/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.824 GO
</a></li></ul></li><li class="dropdown-item"><h4>游戏项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/项目/" class="nav-link"><i class="undefined"></i>
  AI对抗平台 JAVA
</a></li></ul></li><li class="dropdown-item"><h4>合作项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/项目/" class="nav-link"><i class="undefined"></i>
  仿北邮人论坛 JAVA
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      算法
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/LeetCode/" class="nav-link"><i class="undefined"></i>
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      人工智能
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/论文/" class="nav-link"><i class="undefined"></i>
  漏洞检测
</a></li></ul></div></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  归档
</a></div><div class="nav-item"><a href="/review.html" class="nav-link"><i class="iconfont reco-blog"></i>
  回顾
</a></div><div class="nav-item"><a href="/aboutme.html" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-11f94078></div> <aside class="sidebar" data-v-11f94078><div class="personal-info-wrapper" data-v-3d87d2e4 data-v-11f94078><img src="/logo.png" alt="author-avatar" class="personal-img" data-v-3d87d2e4> <h3 class="name" data-v-3d87d2e4>
    AuraroJ
  </h3> <div class="num" data-v-3d87d2e4><div data-v-3d87d2e4><h3 data-v-3d87d2e4>65</h3> <h6 data-v-3d87d2e4>文章</h6></div> <div data-v-3d87d2e4><h3 data-v-3d87d2e4>29</h3> <h6 data-v-3d87d2e4>标签</h6></div></div> <ul class="social-links" data-v-3d87d2e4></ul> <hr data-v-3d87d2e4></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  随性一点的主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/随笔/me.html" class="nav-link"><i class="undefined"></i>
  随笔
</a></li><li class="dropdown-item"><!----> <a href="/面经/" class="nav-link"><i class="undefined"></i>
  面经
</a></li><li class="dropdown-item"><!----> <a href="/network/浏览器输入url过程.html" class="nav-link"><i class="undefined"></i>
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/Os/段式存储和页式存储.html" class="nav-link"><i class="undefined"></i>
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/中间件/" class="nav-link"><i class="undefined"></i>
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/Java-框架/" class="nav-link"><i class="undefined"></i>
  Java框架
</a></li><li class="dropdown-item"><!----> <a href="/Linux/常见面试题.html" class="nav-link"><i class="undefined"></i>
  Linux
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  随笔标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      项目
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>底层项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.830 JAVA
</a></li><li class="dropdown-subitem"><a href="/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.s081 C
</a></li><li class="dropdown-subitem"><a href="/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.824 GO
</a></li></ul></li><li class="dropdown-item"><h4>游戏项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/项目/" class="nav-link"><i class="undefined"></i>
  AI对抗平台 JAVA
</a></li></ul></li><li class="dropdown-item"><h4>合作项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/项目/" class="nav-link"><i class="undefined"></i>
  仿北邮人论坛 JAVA
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      算法
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/LeetCode/" class="nav-link"><i class="undefined"></i>
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      人工智能
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/论文/" class="nav-link"><i class="undefined"></i>
  漏洞检测
</a></li></ul></div></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  归档
</a></div><div class="nav-item"><a href="/review.html" class="nav-link"><i class="iconfont reco-blog"></i>
  回顾
</a></div><div class="nav-item"><a href="/aboutme.html" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>MIT项目</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>MIT数据库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>MIT操作系统</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/项目/MIT6.s081/lab1 Xv6 and Unix utilities.html" class="sidebar-link">操作系统lab1 Xv6 and Unix utilities</a></li><li><a href="/项目/MIT6.s081/lab2 system calls.html" class="sidebar-link">操作系统lab2 system calls</a></li><li><a href="/项目/MIT6.s081/lab3 Page tables.html" class="sidebar-link">操作系统lab3 Page tables</a></li><li><a href="/项目/MIT6.s081/lab4 Trap.html" class="sidebar-link">操作系统lab4 Trap</a></li><li><a href="/项目/MIT6.s081/lab5 Lazy allocation.html" class="sidebar-link">操作系统lab5 Lazy allocation</a></li><li><a href="/项目/MIT6.s081/lab6 Copy-on-write fork.html" class="sidebar-link">操作系统lab6 Copy-on-write fork</a></li><li><a href="/项目/MIT6.s081/lab7 Multithreading.html" class="sidebar-link">操作系统lab7 Multithreading</a></li><li><a href="/项目/MIT6.s081/lab8 locks.html" class="sidebar-link">操作系统lab8 locks</a></li><li><a href="/项目/MIT6.s081/lab9 file system.html" class="sidebar-link">操作系统lab9 file system</a></li><li><a href="/项目/MIT6.s081/lab10 mmap.html" class="active sidebar-link">操作系统lab10 mmap</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>MIT分布式系统</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>游戏项目</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>仿北邮人论坛</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-08f61db9 data-v-11f94078><h3 class="title" data-v-08f61db9>操作系统lab10 mmap</h3> <!----> <label id="box" class="inputBox" data-v-08f61db9><input type="password" value="" data-v-08f61db9> <span data-v-08f61db9>Konck! Knock!</span> <button data-v-08f61db9>OK</button></label> <div class="footer" data-v-08f61db9><span data-v-08f61db9><i class="iconfont reco-theme" data-v-08f61db9></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-08f61db9>vuePress-theme-reco</a></span> <span data-v-08f61db9><i class="iconfont reco-copyright" data-v-08f61db9></i> <a data-v-08f61db9><span data-v-08f61db9>AuraroJ</span>
          
        <!---->
        2022
      </a></span></div></div> <div data-v-11f94078><div data-v-11f94078><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">操作系统lab10 mmap</h1> <div data-v-162cc157><i class="iconfont reco-account" data-v-162cc157><span data-v-162cc157>AuraroJ</span></i> <i class="iconfont reco-date" data-v-162cc157><span data-v-162cc157>2022/10/6</span></i> <i class="iconfont reco-eye" data-v-162cc157><span id="/%E9%A1%B9%E7%9B%AE/MIT6.s081/lab10%20mmap.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-162cc157><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <!----></div></div> <div class="theme-reco-content content__default"><h2 id="mmap"><a href="#mmap" class="header-anchor">#</a> mmap</h2> <h3 id="要点"><a href="#要点" class="header-anchor">#</a> 要点:</h3> <ul><li>实现只考虑内存映射文件的 mmap 和 munmap 系统调用.</li> <li>mmap 参数 addr 一直为 0, 由内核决定映射文件的虚拟地址.</li> <li>mmap 参数 flags 只考虑 MAP_SHARED 和 MAP_PRIVATE.</li> <li>mmap 使用懒分配进行内存映射.</li> <li>定义一个 VMA 结构体来描述一块虚拟内存的信息. 可以用定长数组记录.</li></ul> <h3 id="步骤"><a href="#步骤" class="header-anchor">#</a> 步骤</h3> <ul><li><p><code>Makefile</code> 修改和系统调用定义</p> <ul><li>在 <code>Makefile</code> 中添加 <code>$U/_mmaptest</code></li> <li>添加有关 <code>mmap</code> 和 <code>munmap</code> 系统调用的定义声明. 包括 <code>kernel/syscall.h</code>, <code>kernel/syscall.c</code>, <code>user/usys.pl</code> 和 <code>user/user.h</code>.</li> <li>定义 <code>vm_area</code> 结构体及其数组</li></ul></li> <li><p>定义 <code>vm_area</code> 结构体及其数组</p> <ul><li><p>在 kernel/proc.h 中定义 struct vm_area 结构体.
vm_area 即 Virtual Memory Area, VMA, 此处用于表示使用 mmap 系统调用文件映射的虚拟内存的区域的位置、大小、权限等(实际上在 Linux 中会用来表示整个虚拟内存区域的相关信息, 包括堆、栈等, 而在此部分实验中出于简单考虑只用于表示文件映射部分内存).
struct vm_area 中具体记录的内存信息和 mmap 系统调用的参数基本对应, 包括映射的起始地址、映射内存长度(大小)、权限、mmap 标志位、文件偏移以及指向的文件结构体指针.</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">struct</span> <span class="token class-name">vm_area</span> <span class="token punctuation">{</span>
    uint64 addr<span class="token punctuation">;</span>    <span class="token comment">// mmap address</span>
    <span class="token keyword">int</span> len<span class="token punctuation">;</span>    <span class="token comment">// mmap memory length</span>
    <span class="token keyword">int</span> prot<span class="token punctuation">;</span>   <span class="token comment">// permission</span>
    <span class="token keyword">int</span> flags<span class="token punctuation">;</span>  <span class="token comment">// the mmap flags</span>
    <span class="token keyword">int</span> offset<span class="token punctuation">;</span> <span class="token comment">// the file offset</span>
    <span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> f<span class="token punctuation">;</span>     <span class="token comment">// pointer to the mapped file</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li> <li><p>在 struct proc 结构体中定义相关字段.
处于简单, 根据实验指导的提示, 对于每个进程都使用一个 VMA 的数组来记录映射的内存(实际上根据 Linux 的相关实现, 使用链表效果会更好).
此处定义了 NVMA 表示 VMA 数组的大小. 并在 struct proc 结构体中定义了 vma 数组, 且容易知道 VMA 是进程的私有字段, 因此对于 xv6 的进程单用户线程的系统, 访问 VMA 是无需加锁的.</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NVMA</span> <span class="token expression"><span class="token number">16</span>     </span></span>

<span class="token comment">// Per-process state</span>
<span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>cwd<span class="token punctuation">;</span>           <span class="token comment">// Current directory</span>
  <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>               <span class="token comment">// Process name (debugging)</span>
  <span class="token keyword">struct</span> <span class="token class-name">vm_area</span> vma<span class="token punctuation">[</span>NVMA<span class="token punctuation">]</span><span class="token punctuation">;</span>   
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li></ul></li> <li><p>编写 <code>mmap</code> 系统调用</p> <ul><li>在 <code>kernel/sysfile.c</code> 中实现系统调用 <code>sys_mmap()</code>.</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//在kernel/memlayout.h 中定义了 MMAPMINADDR 宏定义, 用于表示 mmap 可以用于映射的最低地址</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MMAPMINADDR</span> <span class="token expression"><span class="token punctuation">(</span>TRAPFRAME <span class="token operator">-</span> <span class="token number">10</span> <span class="token operator">*</span> PGSIZE<span class="token punctuation">)</span></span></span>

<span class="token comment">// lab10</span>
uint64 <span class="token function">sys_mmap</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  uint64 addr<span class="token punctuation">;</span>
  <span class="token keyword">int</span> len<span class="token punctuation">,</span> prot<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> offset<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">vm_area</span> <span class="token operator">*</span>vma <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">argaddr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span>
      <span class="token operator">||</span> <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>prot<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>flags<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span>
      <span class="token operator">||</span> <span class="token function">argfd</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>f<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">!=</span> MAP_SHARED <span class="token operator">&amp;&amp;</span> flags <span class="token operator">!=</span> MAP_PRIVATE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// the file must be written when flag is MAP_SHARED</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">==</span> MAP_SHARED <span class="token operator">&amp;&amp;</span> f<span class="token operator">-&gt;</span>writable <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>prot <span class="token operator">&amp;</span> PROT_WRITE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// offset must be a multiple of the page size</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> offset <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> offset <span class="token operator">%</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// allocate a VMA for the mapped memory</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NVMA<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vma <span class="token operator">=</span> <span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vma<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// assume that addr will always be 0, the kernel </span>
  <span class="token comment">//choose the page-aligned address at which to create</span>
  <span class="token comment">//the mapping</span>
  addr <span class="token operator">=</span> MMAPMINADDR<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NVMA<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// get the max address of the mapped memory  </span>
      addr <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>addr <span class="token operator">+</span> p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  addr <span class="token operator">=</span> <span class="token function">PGROUNDUP</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">+</span> len <span class="token operator">&gt;</span> TRAPFRAME<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  vma<span class="token operator">-&gt;</span>addr <span class="token operator">=</span> addr<span class="token punctuation">;</span>   
  vma<span class="token operator">-&gt;</span>len <span class="token operator">=</span> len<span class="token punctuation">;</span>
  vma<span class="token operator">-&gt;</span>prot <span class="token operator">=</span> prot<span class="token punctuation">;</span>
  vma<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> flags<span class="token punctuation">;</span>
  vma<span class="token operator">-&gt;</span>offset <span class="token operator">=</span> offset<span class="token punctuation">;</span>
  vma<span class="token operator">-&gt;</span>f <span class="token operator">=</span> f<span class="token punctuation">;</span>
  <span class="token function">filedup</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// increase the file's reference count</span>

  <span class="token keyword">return</span> addr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div></li> <li><p>编写 page fault 处理代码</p> <p>由于在 sys_mmap() 中对文件映射的内存采用的是 Lazy allocation, 因此需要对访问文件映射内存产生的 page fault 进行处理. 和之前 Lazy allocation 和 COW 的实验相同, 即修改 kernel/trap.c 中 usertrap() 的代码.</p> <ul><li>首先就是添加对 page fault 情况的 trap 的检查, 由于映射的内存未分配, 而且该内存读写执行都是有可能的, 因此所有类型的 page fault 都可能发生, 因此 r_scause() 的值包括 12, 13 和 15 三种情况.</li> <li>接下来则是根据发生 page fault 的地址去当前进程的 VMA 数组中找对应的 VMA 结构体.这里需要额外说明的是, 根据 mmap 的 Linux 手册, 文件映射时参数 length 实际上可以超过文件(从 offset 起)的大小, 而且文件映射是以页面为单位的, 因此对应超过文件实际大小的部分, 内容都会是 0, 可以访问修改, 但最后都不会写回文件中. 但是这里寻找 VMA 时对于内存上限是通过 va &lt; p-&gt;vma[i].addr + p-&gt;vma[i].len 进行比较的(没有增加 PGROUNDUP() 是因为 va 事先进行了 PGROUNDDOWN() 向下取整).
找到对应的 VMA 则表明本次 page fault 是由于访问文件映射的内存产生的, 进而继续后面的工作.</li> <li>然后会对 Store Page fault 进行单独的判断, 此处先略过, 这部分是用于脏页标志位(PTE_D)设置的, 在后续进行统一阐述.</li> <li>然后就是进行 Lazy allocation, 使用 kalloc() 先分配一个物理页, 并使用 memset() 进行清空(该步骤是有必要的, kalloc() 分配的页面初始充满 0x5 脏数据).</li> <li>紧接着使用 readi() 根据发生 page fault 的地址从文件的相应部分读取内容到分配的物理页. 这里读取的大小即为 PGSIZE, 若超过文件大小在 readi() 内部会被截取, 并不影响. 在这个过程前后需要对文件的 inode 进行加锁.</li> <li>在读取完文件数据后, 很重要的就是设置该部分的访问权限, 访问权限根据 VMA 中记录的 mmap 的 prot 参数转换为 PTE 的权限标志位. 对于读和执行权限比较简单, 对于写权限此处只有本次是 Store Page fault 时才会设置, 具体原因见后续脏页标志位的说明.</li> <li>最后即可使用 mappages() 将物理页映射到用户进程的页面值.</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span>
<span class="token function">usertrap</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">r_scause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">r_scause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">12</span> <span class="token operator">||</span> <span class="token function">r_scause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">13</span>
             <span class="token operator">||</span> <span class="token function">r_scause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// mmap page fault - lab10</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>pa<span class="token punctuation">;</span>
    uint64 va <span class="token operator">=</span> <span class="token function">PGROUNDDOWN</span><span class="token punctuation">(</span><span class="token function">r_stval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">vm_area</span> <span class="token operator">*</span>vma <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> flags <span class="token operator">=</span> PTE_U<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token comment">// find the VMA</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NVMA<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// like the Linux mmap, it can modify the remaining bytes in</span>
      <span class="token comment">//the end of mapped page</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>addr <span class="token operator">&amp;&amp;</span> va <span class="token operator">&gt;=</span> p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>addr
          <span class="token operator">&amp;&amp;</span> va <span class="token operator">&lt;</span> p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>addr <span class="token operator">+</span> p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vma <span class="token operator">=</span> <span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vma<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// set write flag and dirty flag to the mapped page's PTE</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">r_scause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">15</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>vma<span class="token operator">-&gt;</span>prot <span class="token operator">&amp;</span> PROT_WRITE<span class="token punctuation">)</span>
        <span class="token operator">&amp;&amp;</span> <span class="token function">walkaddr</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>pagetable<span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">uvmsetdirtywrite</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>pagetable<span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pa <span class="token operator">=</span> <span class="token function">kalloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">memset</span><span class="token punctuation">(</span>pa<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">ilock</span><span class="token punctuation">(</span>vma<span class="token operator">-&gt;</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">readi</span><span class="token punctuation">(</span>vma<span class="token operator">-&gt;</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span> pa<span class="token punctuation">,</span> va <span class="token operator">-</span> vma<span class="token operator">-&gt;</span>addr <span class="token operator">+</span> vma<span class="token operator">-&gt;</span>offset<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">iunlock</span><span class="token punctuation">(</span>vma<span class="token operator">-&gt;</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">iunlock</span><span class="token punctuation">(</span>vma<span class="token operator">-&gt;</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>vma<span class="token operator">-&gt;</span>prot <span class="token operator">&amp;</span> PROT_READ<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        flags <span class="token operator">|=</span> PTE_R<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// only store page fault and the mapped page can be written</span>
      <span class="token comment">//set the PTE write flag and dirty flag otherwise don't set</span>
      <span class="token comment">//these two flag until next store page falut</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">r_scause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">15</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>vma<span class="token operator">-&gt;</span>prot <span class="token operator">&amp;</span> PROT_WRITE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        flags <span class="token operator">|=</span> PTE_W <span class="token operator">|</span> PTE_D<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>vma<span class="token operator">-&gt;</span>prot <span class="token operator">&amp;</span> PROT_EXEC<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        flags <span class="token operator">|=</span> PTE_X<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mappages</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>pagetable<span class="token punctuation">,</span> va<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint64<span class="token punctuation">)</span> pa<span class="token punctuation">,</span> flags<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>which_dev <span class="token operator">=</span> <span class="token function">devintr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// ok</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
err<span class="token operator">:</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;usertrap(): unexpected scause %p pid=%d\n&quot;</span><span class="token punctuation">,</span> <span class="token function">r_scause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;            sepc=%p stval=%p\n&quot;</span><span class="token punctuation">,</span> <span class="token function">r_sepc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">r_stval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p<span class="token operator">-&gt;</span>killed <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div></li> <li><p>编写 <code>munmap</code> 系统调用</p> <p>在 kernel/sysfile.c 中实现系统调用 sys_munmap(). 根据实验要求, 该系统调用即将映射的部分内存进行取消映射, 同时若为 MAP_SHARED 则需要将对文件映射内存的修改会写到文件中(在 Linux 中, 会写文件是有 mmap 自动完成的, 与本实验不同).</p> <ul><li><p>首先也是对参数的提取, munmap 只有 addr 和 length 两个参数.</p></li> <li><p>然后对参数进行简单的检查. len 需要非负; 此外根据 Linux 手册, addr 需要是PGSIZE 的整数倍.</p></li> <li><p>接下来同 usertrap() 中类似, 根据 addr 和 length 找到对于的 VMA 结构体. 未找到则返回失败.</p></li> <li><p>然后主要就是判断当前取消映射的部分是否有 MAP_SHARED 标志位, 有的话则需要将该部分写回文件. 当然在此之前先判断 len 是否为 0, 若是的话则直接返回成功, 无需后续的工作.
该部分为该系统调用的最为复杂的部分, 需要考虑的有两点: 一是哪些页面需要写入, 另一方面是每次写回文件的写入大小. 对于前者, 根据实验指导, 选择使用脏页标志位(PTE_D)进行记录, 拥有该标志位则表明改部分被修改过, 则需要将该页面写回文件中, 具体脏页标志位的设置见后续. 对于后者, 由于是根据脏页会写文件的, 因此能够想到写入大小为 PGSIZE, 但由于 len 可能不为 PGSIZE 的整倍数, 此处还需要进行判断. 此外, 根据实验指导, 参考 filewrite() 函数, 一次写入文件的大小还受日志 block 的影响, 因此可能会再分批次写入文件(实际上 PGSIZE 大于 maxsz, 整页需要写会文件时会被分为两次).</p></li> <li><p>在将修改内容写回文件后, 便可以使用 uvmunmap() 将改部分页面在用户页表中取消映射.
这里采用的是向上页面取整的取消页表映射方法, 实际上感觉有些不合理, 因为可能有一部分页面仍未取消文件映射, 但考虑到 addr 需要页面对齐, 因此不会在页面中间取消文件映射, 否则后半部分将无法取消文件映射.
此外, 此处修改了 uvmunmap() 函数的 PTE_V 标志位的检查部分, 和之前 Lazy allocation 的实验相同, 取消映射的页面可能并未实际分配, 此时跳过即可.</p></li> <li><p>最后还要更新一下 VMA 结构体. 因为取消文件映射的部分可能只是 VMA 结构体中文件映射内存的一部分, 但根据实验指导, 取消映射的部分不会在文件映射内存的中间, 即不会由于取消文件映射产生新的一块内存, 因此只需要更新原本 VMA 结构体的相关参数即可. 在整个 VMA 结构体中记录的内存都取消映射时, 则将该 VMA 结构体清空.</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// lab10</span>
uint64 <span class="token function">sys_munmap</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  uint64 addr<span class="token punctuation">,</span> va<span class="token punctuation">;</span>
  <span class="token keyword">int</span> len<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">vm_area</span> <span class="token operator">*</span>vma <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  uint maxsz<span class="token punctuation">,</span> n<span class="token punctuation">,</span> n1<span class="token punctuation">;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">argaddr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">%</span> PGSIZE <span class="token operator">||</span> len <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// find the VMA</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NVMA<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>addr <span class="token operator">&amp;&amp;</span> addr <span class="token operator">&gt;=</span> p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>addr
        <span class="token operator">&amp;&amp;</span> addr <span class="token operator">+</span> len <span class="token operator">&lt;=</span> p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>addr <span class="token operator">+</span> p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vma <span class="token operator">=</span> <span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vma<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>vma<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> MAP_SHARED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// the max size once can write to the disk</span>
    maxsz <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>MAXOPBLOCKS <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> BSIZE<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>va <span class="token operator">=</span> addr<span class="token punctuation">;</span> va <span class="token operator">&lt;</span> addr <span class="token operator">+</span> len<span class="token punctuation">;</span> va <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">uvmgetdirty</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>pagetable<span class="token punctuation">,</span> va<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// only write the dirty page back to the mapped file</span>
      n <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>PGSIZE<span class="token punctuation">,</span> addr <span class="token operator">+</span> len <span class="token operator">-</span> va<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i <span class="token operator">+=</span> n1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        n1 <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>maxsz<span class="token punctuation">,</span> n <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">begin_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ilock</span><span class="token punctuation">(</span>vma<span class="token operator">-&gt;</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">writei</span><span class="token punctuation">(</span>vma<span class="token operator">-&gt;</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> va <span class="token operator">+</span> i<span class="token punctuation">,</span> va <span class="token operator">-</span> vma<span class="token operator">-&gt;</span>addr <span class="token operator">+</span> vma<span class="token operator">-&gt;</span>offset <span class="token operator">+</span> i<span class="token punctuation">,</span> n1<span class="token punctuation">)</span> <span class="token operator">!=</span> n1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">iunlock</span><span class="token punctuation">(</span>vma<span class="token operator">-&gt;</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">iunlock</span><span class="token punctuation">(</span>vma<span class="token operator">-&gt;</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">uvmunmap</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>pagetable<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> <span class="token punctuation">(</span>len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> PGSIZE <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// update the vma</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">==</span> vma<span class="token operator">-&gt;</span>addr <span class="token operator">&amp;&amp;</span> len <span class="token operator">==</span> vma<span class="token operator">-&gt;</span>len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vma<span class="token operator">-&gt;</span>addr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    vma<span class="token operator">-&gt;</span>len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    vma<span class="token operator">-&gt;</span>offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    vma<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    vma<span class="token operator">-&gt;</span>prot <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">fileclose</span><span class="token punctuation">(</span>vma<span class="token operator">-&gt;</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vma<span class="token operator">-&gt;</span>f <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">==</span> vma<span class="token operator">-&gt;</span>addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vma<span class="token operator">-&gt;</span>addr <span class="token operator">+=</span> len<span class="token punctuation">;</span>
    vma<span class="token operator">-&gt;</span>offset <span class="token operator">+=</span> len<span class="token punctuation">;</span>
    vma<span class="token operator">-&gt;</span>len <span class="token operator">-=</span> len<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">+</span> len <span class="token operator">==</span> vma<span class="token operator">-&gt;</span>addr <span class="token operator">+</span> vma<span class="token operator">-&gt;</span>len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vma<span class="token operator">-&gt;</span>len <span class="token operator">-=</span> len<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;unexpected munmap&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div></li></ul></li> <li><p>脏页标志位设置</p> <ul><li><p>首先是在 <code>kernel/riscv.h</code> 中定义了脏页标志位 <code>PTE_D</code>,<code>#define PTE_D (1L &lt;&lt; 7)</code></p></li> <li><p>接下来在 kernel/vm.c 中定义了 uvmgetdirty() 以及 uvmsetdirtywrite() 两个函数. 前者用于读取脏页标志位, 后者用于写入脏页标志位和写标志位(因为两个标志位是同时更新的). 因为返回 PTE 的 walk() 是内部函数, 所有此处选择了定义这两个函数专门用于脏页标志位的相关读写.</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// get the dirty flag of the va's PTE</span>
<span class="token keyword">int</span> <span class="token function">uvmgetdirty</span><span class="token punctuation">(</span>pagetable_t pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pte_t <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> va<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>pte <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_D<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// set the dirty flag and write flag of the va's PTE</span>
<span class="token keyword">int</span> <span class="token function">uvmsetdirtywrite</span><span class="token punctuation">(</span>pagetable_t pagetable<span class="token punctuation">,</span> uint64 va<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pte_t <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token function">walk</span><span class="token punctuation">(</span>pagetable<span class="token punctuation">,</span> va<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>pte <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">*</span>pte <span class="token operator">|=</span> PTE_D <span class="token operator">|</span> PTE_W<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div></li> <li><p>接下来就是关于如何设置脏页标志位. 思路也比较简单, 和 COW 机制有些类似, 即利用 page fault 进行脏页标志位的设置. 对于脏页, 即有修改的页面, 其页面权限一定是可写的, 因此考虑在第一次写页面时通过 trap 处理对页面的 PTE 增加脏页标志位. 主要有两种情景:
一种是对未映射的可写页面进行写操作, 根据前文内容, 此时会通过 trap 进行物理页的分配, 即 Lazy allocation. 而由于触发本次 page fault 的是写操作, 因此后续指令一定会对该页面的内容进行修改, 因此即可添加 PTE_D 脏页标志位.
另一种则是对未映射的可写页面进行读操作或执行操作, 此时同样会进行物理页的分配, 但虽然该页面可写, 但是此时是读操作, 并未修改页面的内容, 因此此时不能添加 PTE_D 标志位, 需要后续写操作时再进行添加. 于是在此时, 并不设置 PTE 的写标志位 PTE_W, 这样页面当前是不可写的, 若后续对页面写操作便会再次触发 page fault, 此时再添加写标志位和脏页标志位.
具体的代码在上述步骤的 kernel/trap.c 的 usertrap() 中. 上文提到的读写执行操作, 可以通过 r_scause() 的返回值进行区分; 而在上述步骤中找到对应 VMA 结构体后的代码 if (r_scause() == 15 &amp;&amp; (vma-&gt;prot &amp; PROT_WRITE) &amp;&amp; walkaddr(p-&gt;pagetable, va)) 即用于区分上述两种情况, r_scause() 为 15 即 Store Page fault, 写操作, 此时 VMA 中记录的映射内存需要同样可写, 且 walkaddr() 返回非 0 值表明已经对该页面分配了内存. 这便是用于上述的第二种情况再次触发 page fault 时进行判断. else 子句中则是步骤中描述的页面分配过程, 而其中通过代码 if (r_scause() == 15 &amp;&amp; (vma-&gt;prot &amp; PROT_WRITE)) 进行脏页标志位和写标志位的设置, 对应上述的第一种情况.</p></li> <li><p>在 usertrap() 中完成了脏页标志位的设置, 在后续 munmap() 便可以通过调用 uvmgetdirty() 来确定页面是否被修改.</p></li></ul></li> <li><p>修改 <code>exit</code> 和 <code>fork</code> 系统调用</p></li></ul> <p>上述内容完成了基本的 <code>mmap</code> 和 <code>munmap</code> 系统调用的部分. 最后需要对 <code>exit</code> 和 <code>fork</code> 两个系统调用进行修改, 添加对进程文件映射内存及 VMA 数组的处理.</p> <ul><li>修改 <code>kernel/proc.c</code> 中的 <code>exit()</code> 函数.
在进程退出时, 需要像 <code>munmap()</code> 一样对文件映射部分内存进行取消映射. 因此添加的代码与 <code>munmap()</code> 中部分基本一样, 区别在于需要遍历 VMA 数组对所有文件映射内存进行取消映射, 而且是整个部分取消.</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span>
<span class="token function">exit</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>p <span class="token operator">==</span> initproc<span class="token punctuation">)</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;init exiting&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// unmap the mapped memory - lab10</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NVMA<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>addr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    vma <span class="token operator">=</span> <span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>vma<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> MAP_SHARED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>va <span class="token operator">=</span> vma<span class="token operator">-&gt;</span>addr<span class="token punctuation">;</span> va <span class="token operator">&lt;</span> vma<span class="token operator">-&gt;</span>addr <span class="token operator">+</span> vma<span class="token operator">-&gt;</span>len<span class="token punctuation">;</span> va <span class="token operator">+=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">uvmgetdirty</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>pagetable<span class="token punctuation">,</span> va<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        n <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>PGSIZE<span class="token punctuation">,</span> vma<span class="token operator">-&gt;</span>addr <span class="token operator">+</span> vma<span class="token operator">-&gt;</span>len <span class="token operator">-</span> va<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> r <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> r <span class="token operator">+=</span> n1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          n1 <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>maxsz<span class="token punctuation">,</span> n <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">begin_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">ilock</span><span class="token punctuation">(</span>vma<span class="token operator">-&gt;</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">writei</span><span class="token punctuation">(</span>vma<span class="token operator">-&gt;</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> va <span class="token operator">+</span> i<span class="token punctuation">,</span> va <span class="token operator">-</span> vma<span class="token operator">-&gt;</span>addr <span class="token operator">+</span> vma<span class="token operator">-&gt;</span>offset <span class="token operator">+</span> i<span class="token punctuation">,</span> n1<span class="token punctuation">)</span> <span class="token operator">!=</span> n1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">iunlock</span><span class="token punctuation">(</span>vma<span class="token operator">-&gt;</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;exit: writei failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token function">iunlock</span><span class="token punctuation">(</span>vma<span class="token operator">-&gt;</span>f<span class="token operator">-&gt;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">end_op</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">uvmunmap</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>pagetable<span class="token punctuation">,</span> vma<span class="token operator">-&gt;</span>addr<span class="token punctuation">,</span> <span class="token punctuation">(</span>vma<span class="token operator">-&gt;</span>len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> PGSIZE <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vma<span class="token operator">-&gt;</span>addr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    vma<span class="token operator">-&gt;</span>len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    vma<span class="token operator">-&gt;</span>offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    vma<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    vma<span class="token operator">-&gt;</span>offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">fileclose</span><span class="token punctuation">(</span>vma<span class="token operator">-&gt;</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vma<span class="token operator">-&gt;</span>f <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Close all open files.</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> fd <span class="token operator">&lt;</span> NOFILE<span class="token punctuation">;</span> fd<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ofile<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>f <span class="token operator">=</span> p<span class="token operator">-&gt;</span>ofile<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">fileclose</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
      p<span class="token operator">-&gt;</span>ofile<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><ul><li>修改 kernel/proc.c 中的 fork() 函数.
在使用 fork() 创建子进程时, 需要将父进程的 VMA 结构体进行拷贝, 从而获得相同的文件映射内存. 由于文件映射内存使用了 Lazy allocation, 所以此时的处理可以比较简单, 直接对父进程的 VMA 数组进行拷贝即可, 当子进程使用文件映射内存时则会通过 page fault 进行页面分配.
当然, 此处可以进行优化, 采用 COW 机制让父子进程指向相同文件映射物理页面, 对于不可写的文件映射内存会十分方便, 且可写的内存则通过 COW 机制重新进行更新.</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">int</span>
<span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token comment">// increment reference counts on open file descriptors.</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NOFILE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ofile<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
      np<span class="token operator">-&gt;</span>ofile<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">filedup</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>ofile<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  np<span class="token operator">-&gt;</span>cwd <span class="token operator">=</span> <span class="token function">idup</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>cwd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// copy all of VMA - lab10</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NVMA<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      np<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">filedup</span><span class="token punctuation">(</span>np<span class="token operator">-&gt;</span>vma<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">safestrcpy</span><span class="token punctuation">(</span>np<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="结果"><a href="#结果" class="header-anchor">#</a> 结果</h3> <p><img src="https://img-blog.csdnimg.cn/22dead4350564a7e83dcb63e59430df9.png" alt="在这里插入图片描述"></p> <p><img src="https://img-blog.csdnimg.cn/a53fc651a8ed474a8b36a0a6125b2119.png" alt="在这里插入图片描述"></p> <p><img src="https://img-blog.csdnimg.cn/7c9681e23850443e851aaa15003062b6.png" alt="在这里插入图片描述"></p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2022/10/6 下午1:59:19</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/项目/MIT6.s081/lab9 file system.html" class="prev">
          操作系统lab9 file system
        </a></span> <span class="next"><a href="/项目/MIT6.824/lab1.html">
          分布式系统lab1
        </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-2c0089e8><li class="level-2" data-v-2c0089e8><a href="/%E9%A1%B9%E7%9B%AE/MIT6.s081/lab10%20mmap.html#mmap" class="sidebar-link reco-side-mmap" data-v-2c0089e8>mmap</a></li><li class="level-3" data-v-2c0089e8><a href="/%E9%A1%B9%E7%9B%AE/MIT6.s081/lab10%20mmap.html#要点" class="sidebar-link reco-side-要点" data-v-2c0089e8>要点:</a></li><li class="level-3" data-v-2c0089e8><a href="/%E9%A1%B9%E7%9B%AE/MIT6.s081/lab10%20mmap.html#步骤" class="sidebar-link reco-side-步骤" data-v-2c0089e8>步骤</a></li><li class="level-3" data-v-2c0089e8><a href="/%E9%A1%B9%E7%9B%AE/MIT6.s081/lab10%20mmap.html#结果" class="sidebar-link reco-side-结果" data-v-2c0089e8>结果</a></li></ul></main></div> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="Sakura" data-v-248d85d6><canvas id="canvas_sakura" style="z-index:-1;" data-v-248d85d6></canvas></div><canvas id="vuepress-canvas-cursor"></canvas><!----></div></div>
    <script src="/assets/js/app.bb08115f.js" defer></script><script src="/assets/js/3.583d0c72.js" defer></script><script src="/assets/js/1.eb42dbb0.js" defer></script><script src="/assets/js/275.20c3ffb2.js" defer></script>
  </body>
</html>
